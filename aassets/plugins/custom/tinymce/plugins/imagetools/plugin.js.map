{"version":3,"sources":["imagetools/plugin.js"],"names":["domGlobals","eq","call","id","me","Cell","initial","value","get","set","v","clone","global","tinymce","util","Tools","resolve","global$1","noop","constant","never","always","none","NONE","o","isNone","fold","n","s","is","isSome","getOr","getOrThunk","thunk","getOrDie","msg","Error","getOrNull","getOrUndefined","undefined","or","orThunk","map","each","bind","exists","forall","filter","equals","equals_","toArray","toString","Object","freeze","some","a","constant_a","self","f","elementEq","b","Option","from","create","width","height","resize","document","createElement","canvas","tCanvas","get2dContext","drawImage","getContext","Promise","window","fn","this","TypeError","_state","_value","_deferreds","doResolve","reject","asap","immediateFn","setImmediate","setTimeout","thisArg","apply","arguments","isArray","Array","prototype","handle","deferred","cb","onFulfilled","onRejected","ret","e","push","newValue","then","finale","_i","_a","length","Handler","done","reason","ex","catch","all","values","args","slice","remaining","res","i","val","constructor","race","values_1","promise","imageToBlob","image","url","src","indexOf","dataUriToBlob","xhr","XMLHttpRequest","open","responseType","onload","status","response","onerror","obj","_this","code","name","send","blobToImage","blob","blobUrl","URL","createObjectURL","Image","removeListeners","removeEventListener","loaded","error","type","addEventListener","complete","uri","data","split","matches","exec","mimetype","base64","byteCharacters","atob","bytesLength","slicesCount","Math","ceil","byteArrays","sliceIndex","begin","end","min","bytes","offset","charCodeAt","Uint8Array","Blob","dataUriToBlobSync","canvasToBlob","quality","HTMLCanvasElement","toBlob","toDataURL","blobToCanvas","revokeObjectURL","revokeImageUrl","naturalWidth","getWidth","naturalHeight","getHeight","create$1","getCanvas","initialType","toAdjustedDataURL","canvasToDataURL","getType","toBase64","toAdjustedBlob","toAdjustedBase64","dataurl","toCanvas","fromBlob","reader","FileReader","onloadend","result","readAsDataURL","blobToDataUri","fromCanvas","rotate","ir","angle","context","translateX","translateY","translate","PI","applyRotate","flip","axis","scale","applyFlip","blobToImageResult","global$2","global$3","global$4","getToolbarItems","editor","getParam","ImageSize","getImageSize","img","isPxValue","test","style","w","parseInt","h","setImageSize","size","removeAttribute","setAttribute","getNaturalImageSize","isFunction","x","t","isPrototypeOf","String","typeOf","nativeSlice","find","xs","pred","len","isValue","Utils","traverse","json","path","reduce","key","readBlob","fr","target","readAsText","requestUrlAsBlob","headers","withCredentials","onreadystatechange","readyState","setRequestHeader","parseJson","text","JSON","parse","friendlyHttpErrors","message","friendlyServiceErrors","getHttpErrorMsg","handleHttpError","getServiceErrorMsg","handleServiceError","serviceError","errorType","getServiceError","Errors","handleServiceErrorResponse","requestServiceBlob","apiKey","Content-Type","tiny-api-key","separator","encodeURIComponent","appendApiKey","getUrl","requestBlob","compareDocumentPosition","match","Node","DOCUMENT_POSITION_CONTAINED_BY","unknown","nu","major","minor","Version","detect","versionRegexes","agent","cleanedAgent","toLowerCase","regexes","r","firstMatch","group","Number","replace","find$1","isBrowser","current","nu$1","info","version","isEdge","isChrome","isIE","isOpera","isFirefox","isSafari","Browser","edge","chrome","ie","opera","firefox","safari","isOS","nu$2","isWindows","isiOS","isAndroid","isOSX","isLinux","isSolaris","isFreeBSD","OperatingSystem","windows","ios","android","linux","osx","solaris","freebsd","detect$1","candidates","userAgent","candidate","search","UaString","browsers","browser","oses","os","contains","str","substr","normalVersionRegex","checkContains","uastring","PlatformInfo","PlatformDetection","mediaMatch","deviceType","isiPad","isiPhone","isMobile","isTouch","isTablet","isPhone","iOSwebview","isDesktop","isWebView","DeviceType","platform","navigator","query","matchMedia","fromDom","node","dom","Element","fromHtml","html","scope","div","innerHTML","hasChildNodes","childNodes","console","fromTag","tag","fromText","createTextNode","fromPoint","docElm","y","doc","elementFromPoint","ELEMENT","ATTRIBUTE_NODE","CDATA_SECTION_NODE","COMMENT_NODE","DOCUMENT_NODE","DOCUMENT_TYPE_NODE","DOCUMENT_FRAGMENT_NODE","ELEMENT_NODE","ELEMENT$1","TEXT_NODE","PROCESSING_INSTRUCTION_NODE","ENTITY_REFERENCE_NODE","ENTITY_NODE","NOTATION_NODE","child$1","Function","selector","predicate","child","element","nodeType","elem","msMatchesSelector","webkitMatchesSelector","mozMatchesSelector","count","getFigureImg","isFigure","displayError","notificationManager","getSelectedImage","selection","getNode","isLocalImage","host","documentBaseURI","isCorsImage","inArray","getCorsHosts","defaultFetchImage","getCredentialsHosts","isCorsWithCredentialsImage","getProxyUrl","getApiKey","imageToBlob$2","getFetchImage","customFetchImage","findBlob","blobInfo","editorUpload","blobCache","getByUri","startTimedUpload","imageUploadTimerState","imageUploadTimer","setEditorTimeout","uploadImagesAuto","getUploadTimeout","cancelTimedUpload","clearTimeout","updateSelectedImage","uploadImmediately","selectedImage","shouldReuseFilename","m","encode","extractFilename","add","undoManager","transact","$","on","imageLoadedHandler","off","nodeChanged","attr","blobUri","removeAttr","selectedImageOperation","_scanForImages","imageResult","Actions","flippedSize","rotate$1","flip$1","getEditableImage","isEditable","imgNode","isImage","settings","imagetools_proxy","handleDialogBlob","originalSize","blobToImage$1","newImage","newSize","saveState","disable","enable","Dialog","originalImgOpt","originalSizeOpt","origImg","_","state","createState","windowManager","title","body","items","label","currentState","buttons","primary","disabled","onSubmit","api","getData","imagetools","originalImg","close","onCancel","onAction","details","Commands","register","mceImageRotateLeft","mceImageRotateRight","mceImageFlipVertical","mceImageFlipHorizontal","mceEditImage","cmd","addCommand","UploadSelectedImage","setup","lastSelectedImageState","lastSelectedImage","Buttons","command","execCommand","ui","registry","addButton","tooltip","icon","onSetup","buttonApi","setDisabled","addContextMenu","update","ContextToolbar","addContextToolbar","position"],"mappings":"CAQC,SAAUA,GACP,aAEA,IAoCMC,EAGAC,EAGAC,EAGAC,EA7CFC,EAAO,SAAUC,GACnB,IAAIC,EAAQD,EACRE,EAAM,WACR,OAAOD,GAQT,MAAO,CACLC,IAAKA,EACLC,IARQ,SAAUC,GAClBH,EAAQG,GAQRC,MANU,WACV,OAAON,EAAKG,QASZI,EAASC,QAAQC,KAAKC,MAAMC,QAAQ,yBAEpCC,EAAWJ,QAAQC,KAAKC,MAAMC,QAAQ,sBAEtCE,EAAO,aAEPC,EAAW,SAAUZ,GACvB,OAAO,WACL,OAAOA,IAGPa,EAAQD,GAAS,GACjBE,EAASF,GAAS,GAElBG,EAAO,WACT,OAAOC,GAELA,GACEtB,EAAK,SAAUuB,GACjB,OAAOA,EAAEC,UAQPrB,EAAK,CACPsB,KAAM,SAAUC,EAAGC,GACjB,OAAOD,KAETE,GAAIT,EACJU,OAAQV,EACRK,OAAQJ,EACRU,MAVE5B,EAAK,SAAUwB,GACjB,OAAOA,GAUPK,WAdE9B,EAAO,SAAU+B,GACnB,OAAOA,KAcPC,SAAU,SAAUC,GAClB,MAAM,IAAIC,MAAMD,GAAO,oCAEzBE,UAAWlB,EAAS,MACpBmB,eAAgBnB,OAASoB,GACzBC,GAAIrC,EACJsC,QAASvC,EACTwC,IAAKpB,EACLqB,KAAMzB,EACN0B,KAAMtB,EACNuB,OAAQzB,EACR0B,OAAQzB,EACR0B,OAAQzB,EACR0B,OAAQ/C,EACRgD,QAAShD,EACTiD,QAAS,WACP,MAAO,IAETC,SAAUhC,EAAS,WAEjBiC,OAAOC,QACTD,OAAOC,OAAOjD,GAETA,GAELkD,EAAO,SAAUC,GACnB,IAAIC,EAAarC,EAASoC,GACtBE,EAAO,WACT,OAAOrD,GAELwC,EAAO,SAAUc,GACnB,OAAOA,EAAEH,IAEPnD,EAAK,CACPsB,KAAM,SAAUC,EAAGC,GACjB,OAAOA,EAAE2B,IAEX1B,GAAI,SAAUnB,GACZ,OAAO6C,IAAM7C,GAEfoB,OAAQT,EACRI,OAAQL,EACRW,MAAOyB,EACPxB,WAAYwB,EACZtB,SAAUsB,EACVnB,UAAWmB,EACXlB,eAAgBkB,EAChBhB,GAAIiB,EACJhB,QAASgB,EACTf,IAAK,SAAUgB,GACb,OAAOJ,EAAKI,EAAEH,KAEhBZ,KAAM,SAAUe,GACdA,EAAEH,IAEJX,KAAMA,EACNC,OAAQD,EACRE,OAAQF,EACRG,OAAQ,SAAUW,GAChB,OAAOA,EAAEH,GAAKnD,EAAKmB,GAErB2B,QAAS,WACP,MAAO,CAACK,IAEVJ,SAAU,WACR,MAAO,QAAUI,EAAI,KAEvBP,OAAQ,SAAUxB,GAChB,OAAOA,EAAEK,GAAG0B,IAEdN,QAAS,SAAUzB,EAAGmC,GACpB,OAAOnC,EAAEE,KAAKN,EAAO,SAAUwC,GAC7B,OAAOD,EAAUJ,EAAGK,OAI1B,OAAOxD,GAKLyD,EAAS,CACXP,KAAMA,EACNhC,KAAMA,EACNwC,KANS,SAAUvD,GACnB,OAAOA,MAAAA,EAAwCgB,EAAO+B,EAAK/C,KAQ7D,SAASwD,EAAOC,EAAOC,GACrB,OAAOC,EAAOlE,EAAWmE,SAASC,cAAc,UAAWJ,EAAOC,GAEpE,SAAStD,EAAM0D,GACb,IAAIC,EAAUP,EAAOM,EAAOL,MAAOK,EAAOJ,QAG1C,OAFUM,EAAaD,GACnBE,UAAUH,EAAQ,EAAG,GAClBC,EAET,SAASC,EAAaF,GACpB,OAAOA,EAAOI,WAAW,MAE3B,SAASP,EAAOG,EAAQL,EAAOC,GAG7B,OAFAI,EAAOL,MAAQA,EACfK,EAAOJ,OAASA,EACTI,EAUT,IA8KIK,EAAUC,OAAOD,QAAUC,OAAOD,QA9KxB,WACZ,IAAIA,EAAU,SAAUE,GACtB,GAAoB,iBAATC,KACT,MAAM,IAAIC,UAAU,wCAEtB,GAAkB,mBAAPF,EACT,MAAM,IAAIE,UAAU,kBAEtBD,KAAKE,OAAS,KACdF,KAAKG,OAAS,KACdH,KAAKI,WAAa,GAClBC,EAAUN,EAAIhC,EAAK5B,EAAS6D,MAAOjC,EAAKuC,EAAQN,QAE9CO,EAAOV,EAAQW,aAA8C,mBAAxBV,OAAOW,cAA+BX,OAAOW,cAAgB,SAAUV,GAC9G5E,EAAWuF,WAAWX,EAAI,IAE5B,SAAShC,EAAKgC,EAAIY,GAChB,OAAO,WACL,OAAOZ,EAAGa,MAAMD,EAASE,YAG7B,IAAIC,EAAUC,MAAMD,SAAW,SAAUpF,GACvC,MAAiD,mBAA1C6C,OAAOyC,UAAU1C,SAASjD,KAAKK,IAExC,SAASuF,EAAOC,GACd,IAAI3F,EAAKyE,KACW,OAAhBA,KAAKE,OAITK,EAAK,WACH,IAAIY,EAAK5F,EAAG2E,OAASgB,EAASE,YAAcF,EAASG,WACrD,GAAW,OAAPF,EAAJ,CAIA,IAAIG,EACJ,IACEA,EAAMH,EAAG5F,EAAG4E,QACZ,MAAOoB,GAEP,YADAL,EAASZ,OAAOiB,GAGlBL,EAAS/E,QAAQmF,QAVd/F,EAAG2E,OAASgB,EAAS/E,QAAU+E,EAASZ,QAAQ/E,EAAG4E,UANtDH,KAAKI,WAAWoB,KAAKN,GAmBzB,SAAS/E,EAAQsF,GACf,IACE,GAAIA,IAAazB,KACf,MAAM,IAAIC,UAAU,6CAEtB,GAAIwB,IAAiC,iBAAbA,GAA6C,mBAAbA,GAA0B,CAChF,IAAIC,EAAOD,EAASC,KACpB,GAAoB,mBAATA,EAET,YADArB,EAAUtC,EAAK2D,EAAMD,GAAW1D,EAAK5B,EAAS6D,MAAOjC,EAAKuC,EAAQN,OAItEA,KAAKE,QAAS,EACdF,KAAKG,OAASsB,EACdE,EAAOtG,KAAK2E,MACZ,MAAOuB,GACPjB,EAAOjF,KAAK2E,KAAMuB,IAGtB,SAASjB,EAAOmB,GACdzB,KAAKE,QAAS,EACdF,KAAKG,OAASsB,EACdE,EAAOtG,KAAK2E,MAEd,SAAS2B,IACP,IAAK,IAAIC,EAAK,EAAGC,EAAK7B,KAAKI,WAAYwB,EAAKC,EAAGC,OAAQF,IAAM,CAC3D,IAAIV,EAAWW,EAAGD,GAClBX,EAAO5F,KAAK2E,KAAMkB,GAEpBlB,KAAKI,WAAa,GAEpB,SAAS2B,EAAQX,EAAaC,EAAYlF,EAASmE,GACjDN,KAAKoB,YAAqC,mBAAhBA,EAA6BA,EAAc,KACrEpB,KAAKqB,WAAmC,mBAAfA,EAA4BA,EAAa,KAClErB,KAAK7D,QAAUA,EACf6D,KAAKM,OAASA,EAEhB,SAASD,EAAUN,EAAIqB,EAAaC,GAClC,IAAIW,GAAO,EACX,IACEjC,EAAG,SAAUrE,GACPsG,IAGJA,GAAO,EACPZ,EAAY1F,KACX,SAAUuG,GACPD,IAGJA,GAAO,EACPX,EAAWY,MAEb,MAAOC,GACP,GAAIF,EACF,OAEFA,GAAO,EACPX,EAAWa,IAoEf,OAjEArC,EAAQmB,UAAUmB,MAAQ,SAAUd,GAClC,OAAOrB,KAAK0B,KAAK,KAAML,IAEzBxB,EAAQmB,UAAUU,KAAO,SAAUN,EAAaC,GAC9C,IAAI9F,EAAKyE,KACT,OAAO,IAAIH,EAAQ,SAAU1D,EAASmE,GACpCW,EAAO5F,KAAKE,EAAI,IAAIwG,EAAQX,EAAaC,EAAYlF,EAASmE,OAGlET,EAAQuC,IAAM,WAEZ,IADA,IAAIC,EAAS,GACJT,EAAK,EAAGA,EAAKf,UAAUiB,OAAQF,IACtCS,EAAOT,GAAMf,UAAUe,GAEzB,IAAIU,EAAOvB,MAAMC,UAAUuB,MAAMlH,KAAuB,IAAlBgH,EAAOP,QAAgBhB,EAAQuB,EAAO,IAAMA,EAAO,GAAKA,GAC9F,OAAO,IAAIxC,EAAQ,SAAU1D,EAASmE,GACpC,GAAoB,IAAhBgC,EAAKR,OACP,OAAO3F,EAAQ,IAEjB,IAAIqG,EAAYF,EAAKR,OACrB,SAASW,EAAIC,EAAGC,GACd,IACE,GAAIA,IAAuB,iBAARA,GAAmC,mBAARA,GAAqB,CACjE,IAAIjB,EAAOiB,EAAIjB,KACf,GAAoB,mBAATA,EAIT,YAHAA,EAAKrG,KAAKsH,EAAK,SAAUA,GACvBF,EAAIC,EAAGC,IACNrC,GAIPgC,EAAKI,GAAKC,EACU,KAAdH,GACJrG,EAAQmG,GAEV,MAAOJ,GACP5B,EAAO4B,IAGX,IAAK,IAAIQ,EAAI,EAAGA,EAAIJ,EAAKR,OAAQY,IAC/BD,EAAIC,EAAGJ,EAAKI,OAIlB7C,EAAQ1D,QAAU,SAAUT,GAC1B,OAAIA,GAA0B,iBAAVA,GAAsBA,EAAMkH,cAAgB/C,EACvDnE,EAEF,IAAImE,EAAQ,SAAU1D,GAC3BA,EAAQT,MAGZmE,EAAQS,OAAS,SAAU2B,GACzB,OAAO,IAAIpC,EAAQ,SAAU1D,EAASmE,GACpCA,EAAO2B,MAGXpC,EAAQgD,KAAO,SAAUR,GACvB,OAAO,IAAIxC,EAAQ,SAAU1D,EAASmE,GACpC,IAAK,IAAIsB,EAAK,EAAGkB,EAAWT,EAAQT,EAAKkB,EAAShB,OAAQF,IAC5CkB,EAASlB,GACfF,KAAKvF,EAASmE,MAInBT,EAEuCkD,GAEhD,SAASC,EAAYC,GACnB,IA8BoBC,EA9BhBC,EAAMF,EAAME,IAChB,OAA6B,IAAzBA,EAAIC,QAAQ,SACPC,EAAcF,IA4BHD,EA1BAC,EA2Bb,IAAItD,EAAQ,SAAU1D,EAASmE,GACpC,IAAIgD,EAAM,IAAInI,EAAWoI,eACzBD,EAAIE,KAAK,MAAON,GAAK,GACrBI,EAAIG,aAAe,OACnBH,EAAII,OAAS,WACS,MAAhB1D,KAAK2D,QACPxH,EAAQ6D,KAAK4D,WAGjBN,EAAIO,QAAU,WACZ,IAEMC,EAFFC,EAAQ/D,KAUZM,EAAuB,IAAhBN,KAAK2D,SARNG,EAAM,IAAIvG,MAAM,gCAChByG,KAAO,GACXF,EAAIG,KAAO,gBACJH,GAGA,IAAIvG,MAAM,SAAWwG,EAAMJ,OAAS,wBAI/CL,EAAIY,UA/CR,SAASC,EAAYC,GACnB,OAAO,IAAIvE,EAAQ,SAAU1D,EAASmE,GACpC,IAAI+D,EAAUlJ,EAAWmJ,IAAIC,gBAAgBH,GACzCnB,EAAQ,IAAI9H,EAAWqJ,MACvBC,EAAkB,WACpBxB,EAAMyB,oBAAoB,OAAQC,GAClC1B,EAAMyB,oBAAoB,QAASE,IAErC,SAASD,IACPF,IACAtI,EAAQ8G,GAEV,SAAS2B,IACPH,IACAnE,EAAO,+BAAiC8D,EAAKS,KAAO,KAAOR,GAE7DpB,EAAM6B,iBAAiB,OAAQH,GAC/B1B,EAAM6B,iBAAiB,QAASF,GAChC3B,EAAME,IAAMkB,EACRpB,EAAM8B,UACRJ,MAsDN,SAAStB,EAAc2B,GACrB,OAAO,IAAInF,EAAQ,SAAU1D,EAASmE,IAzBxC,SAA2B0E,GACzB,IAAIC,EAAOD,EAAIE,MAAM,KACjBC,EAAU,eAAeC,KAAKH,EAAK,IACvC,IAAKE,EACH,OAAOnG,EAAOvC,OAShB,IAPA,IAAI4I,EAAWF,EAAQ,GACnBG,EAASL,EAAK,GAEdM,EAAiBpK,EAAWqK,KAAKF,GACjCG,EAAcF,EAAezD,OAC7B4D,EAAcC,KAAKC,KAAKH,EAHZ,MAIZI,EAAa,IAAI9E,MAAM2E,GAClBI,EAAa,EAAGA,EAAaJ,IAAeI,EAAY,CAI/D,IAHA,IAAIC,EANU,KAMFD,EACRE,EAAML,KAAKM,IAAIF,EAPL,KAOwBN,GAClCS,EAAQ,IAAInF,MAAMiF,EAAMD,GACnBI,EAASJ,EAAOrD,EAAI,EAAGyD,EAASH,IAAOtD,IAAKyD,EACnDD,EAAMxD,GAAK6C,EAAeY,GAAQC,WAAW,GAE/CP,EAAWC,GAAc,IAAIO,WAAWH,GAE1C,OAAOlH,EAAOP,KAAK,IAAItD,EAAWmL,KAAKT,EAAY,CAAEhB,KAAMQ,MAIzDkB,CAAkBvB,GAAKnI,KAAK,WAC1ByD,EAAO,sBAAwB0E,IAC9B7I,KAGP,SAASqK,EAAahH,EAAQqF,EAAM4B,GAElC,OADA5B,EAAOA,GAAQ,YACX1J,EAAWuL,kBAAkB1F,UAAU2F,OAClC,IAAI9G,EAAQ,SAAU1D,EAASmE,GACpCd,EAAOmH,OAAO,SAAUvC,GAClBA,EACFjI,EAAQiI,GAER9D,KAEDuE,EAAM4B,KAGJpD,EAAc7D,EAAOoH,UAAU/B,EAAM4B,IAOhD,SAASI,EAAazC,GACpB,OAAOD,EAAYC,GAAM1C,KAAK,SAAUuB,IAiB1C,SAAwBA,GACtB9H,EAAWmJ,IAAIwC,gBAAgB7D,EAAME,KAjBnC4D,CAAe9D,GACf,IAAIzD,EAASN,EAtSjB,SAAkB+D,GAChB,OAAOA,EAAM+D,cAAgB/D,EAAM9D,MAqSb8H,CAAShE,GAnSjC,SAAmBA,GACjB,OAAOA,EAAMiE,eAAiBjE,EAAM7D,OAkSG+H,CAAUlE,IAG/C,OAFcvD,EAAaF,GACnBG,UAAUsD,EAAO,EAAG,GACrBzD,IAuBX,SAAS4H,EAASC,EAAWjD,EAAMY,GACjC,IAAIsC,EAAclD,EAAKS,KAgBvB,SAAS0C,EAAkB1C,EAAM4B,GAC/B,OAAOY,EAAU3F,KAAK,SAAUlC,GAC9B,OApDN,SAAyBA,EAAQqF,EAAM4B,GAErC,OADA5B,EAAOA,GAAQ,YACRrF,EAAOoH,UAAU/B,EAAM4B,GAkDnBe,CAAgBhI,EAAQqF,EAAM4B,KAWzC,MAAO,CACLgB,QA7BYnL,EAASgL,GA8BrBX,OA7BF,WACE,OAAO9G,EAAQ1D,QAAQiI,IA6BvBwC,UA3BF,WACE,OAAO5B,GA2BP0C,SAzBF,WACE,OAAO1C,EAAIE,MAAM,KAAK,IAyBtByC,eAvBF,SAAwB9C,EAAM4B,GAC5B,OAAOY,EAAU3F,KAAK,SAAUlC,GAC9B,OAAOgH,EAAahH,EAAQqF,EAAM4B,MAsBpCc,kBAAmBA,EACnBK,iBAfF,SAA0B/C,EAAM4B,GAC9B,OAAOc,EAAkB1C,EAAM4B,GAAS/E,KAAK,SAAUmG,GACrD,OAAOA,EAAQ3C,MAAM,KAAK,MAc5B4C,SAXF,WACE,OAAOT,EAAU3F,KAAK5F,KAa1B,SAASiM,EAAS3D,GAChB,OA9DF,SAAuBA,GACrB,OAAO,IAAIvE,EAAQ,SAAU1D,GAC3B,IAAI6L,EAAS,IAAI7M,EAAW8M,WAC5BD,EAAOE,UAAY,WACjB/L,EAAQ6L,EAAOG,SAEjBH,EAAOI,cAAchE,KAwDhBiE,CAAcjE,GAAM1C,KAAK,SAAUsD,GACxC,OAAOoC,EAASP,EAAazC,GAAOA,EAAMY,KAG9C,SAASsD,EAAW9I,EAAQqF,GAC1B,OAAO2B,EAAahH,EAAQqF,GAAMnD,KAAK,SAAU0C,GAC/C,OAAOgD,EAASvH,EAAQ1D,QAAQqD,GAAS4E,EAAM5E,EAAOoH,eAI1D,SAAS2B,EAAOC,EAAIC,GAClB,OAAOD,EAAGV,WAAWpG,KAAK,SAAUlC,GAClC,OAGJ,SAAqByD,EAAO4B,EAAM4D,GAChC,IAAIjJ,EAASN,EAAO+D,EAAM9D,MAAO8D,EAAM7D,QACnCsJ,EAAUhJ,EAAaF,GACvBmJ,EAAa,EACbC,EAAa,EAEH,MADdH,EAAQA,EAAQ,EAAI,IAAMA,EAAQA,IACJ,MAAVA,GAClBpJ,EAAOG,EAAQA,EAAOJ,OAAQI,EAAOL,OAEzB,KAAVsJ,GAA0B,MAAVA,IAClBE,EAAanJ,EAAOL,OAER,MAAVsJ,GAA2B,MAAVA,IACnBG,EAAapJ,EAAOJ,QAKtB,OAHAsJ,EAAQG,UAAUF,EAAYC,GAC9BF,EAAQH,OAAOE,EAAQ9C,KAAKmD,GAAK,KACjCJ,EAAQ/I,UAAUsD,EAAO,EAAG,GACrBqF,EAAW9I,EAAQqF,GArBjBkE,CAAYvJ,EAAQgJ,EAAGf,UAAWgB,KAuB7C,SAASO,EAAKR,EAAIS,GAChB,OAAOT,EAAGV,WAAWpG,KAAK,SAAUlC,GAClC,OAGJ,SAAmByD,EAAO4B,EAAMoE,GAC9B,IAAIzJ,EAASN,EAAO+D,EAAM9D,MAAO8D,EAAM7D,QACnCsJ,EAAUhJ,EAAaF,GACd,MAATyJ,GACFP,EAAQQ,MAAM,GAAI,GAClBR,EAAQ/I,UAAUsD,EAAO,GAAIzD,EAAOJ,UAEpCsJ,EAAQQ,OAAO,EAAG,GAClBR,EAAQ/I,UAAUsD,GAAQzD,EAAOL,MAAO,IAE1C,OAAOmJ,EAAW9I,EAAQqF,GAbjBsE,CAAU3J,EAAQgJ,EAAGf,UAAWwB,KAgB3C,IAOIG,EAAoB,SAAUhF,GAChC,OAAO2D,EAAS3D,IAGdiF,EAAWrN,QAAQC,KAAKC,MAAMC,QAAQ,sBAEtCmN,EAAWtN,QAAQC,KAAKC,MAAMC,QAAQ,wBAEtCoN,EAAWvN,QAAQC,KAAKC,MAAMC,QAAQ,oBAEtCqN,EAAkB,SAAUC,GAC9B,OAAOA,EAAOC,SAAS,qBAAsB,8DA0E/C,IAmBuB7E,EAnBnB8E,EAAY,CACdC,aAnDF,SAAsBC,GACpB,IAAI1K,EAAOC,EACX,SAAS0K,EAAUpO,GACjB,MAAO,eAAeqO,KAAKrO,GAI7B,OAFAyD,EAAQ0K,EAAIG,MAAM7K,MAClBC,EAASyK,EAAIG,MAAM5K,OACfD,GAASC,EACP0K,EAAU3K,IAAU2K,EAAU1K,GACzB,CACL6K,EAAGC,SAAS/K,EAAO,IACnBgL,EAAGD,SAAS9K,EAAQ,KAGjB,MAETD,EAAQ0K,EAAI1K,MACZC,EAASyK,EAAIzK,OACTD,GAASC,EACJ,CACL6K,EAAGC,SAAS/K,EAAO,IACnBgL,EAAGD,SAAS9K,EAAQ,KAGjB,OA4BPgL,aA1BF,SAAsBP,EAAKQ,GACzB,IAAIlL,EAAOC,EACPiL,IACFlL,EAAQ0K,EAAIG,MAAM7K,MAClBC,EAASyK,EAAIG,MAAM5K,QACfD,GAASC,KACXyK,EAAIG,MAAM7K,MAAQkL,EAAKJ,EAAI,KAC3BJ,EAAIG,MAAM5K,OAASiL,EAAKF,EAAI,KAC5BN,EAAIS,gBAAgB,mBAEtBnL,EAAQ0K,EAAI1K,MACZC,EAASyK,EAAIzK,QACTD,GAASC,KACXyK,EAAIU,aAAa,QAASF,EAAKJ,GAC/BJ,EAAIU,aAAa,SAAUF,EAAKF,MAapCK,oBATF,SAA6BX,GAC3B,MAAO,CACLI,EAAGJ,EAAI7C,aACPmD,EAAGN,EAAI3C,iBA2BPuD,GALmB5F,EAKC,WAJf,SAAUnJ,GACf,OAfS,SAAUgP,GACrB,GAAU,OAANA,EACF,MAAO,OAET,IAAIC,SAAWD,EACf,MAAU,WAANC,IAAmB5J,MAAMC,UAAU4J,cAAcF,IAAMA,EAAE9H,aAAsC,UAAvB8H,EAAE9H,YAAYqB,MACjF,QAEC,WAAN0G,IAAmBE,OAAO7J,UAAU4J,cAAcF,IAAMA,EAAE9H,aAAsC,WAAvB8H,EAAE9H,YAAYqB,MAClF,SAEF0G,EAIEG,CAAOpP,KAAWmJ,IAKzBkG,EAAchK,MAAMC,UAAUuB,MAC9ByI,EAAO,SAAUC,EAAIC,GACvB,IAAK,IAAIxI,EAAI,EAAGyI,EAAMF,EAAGnJ,OAAQY,EAAIyI,EAAKzI,IAAK,CAC7C,IAAIgI,EAAIO,EAAGvI,GACX,GAAIwI,EAAKR,EAAGhI,GACV,OAAO1D,EAAOP,KAAKiM,GAGvB,OAAO1L,EAAOvC,QAMZ2O,GAJSX,EAAW1J,MAAM9B,OAAQ8B,MAAM9B,KAI9B,SAAU6E,GACtB,OAAOA,MAAAA,IAgDLuH,EAAQ,CACVC,SA/Ca,SAAUC,EAAMC,GAC7B,IAAI9P,EAIJ,OAHAA,EAAQ8P,EAAKC,OAAO,SAAUtD,EAAQuD,GACpC,OAAON,EAAQjD,GAAUA,EAAOuD,QAAOhO,GACtC6N,GACIH,EAAQ1P,GAASA,EAAQ,MA2ChCiQ,SApBa,SAAUvH,GACvB,OAAO,IAAIkF,EAAS,SAAUnN,GAC5B,IAAIyP,EAAK,IAAIzQ,EAAW8M,WACxB2D,EAAGlI,OAAS,SAAUnC,GACpB,IAAI0D,EAAO1D,EAAEsK,OACb1P,EAAQ8I,EAAKkD,SAEfyD,EAAGE,WAAW1H,MAchB2H,iBA1CqB,SAAU7I,EAAK8I,EAASC,GAC7C,OAAO,IAAI3C,EAAS,SAAUnN,GAC5B,IAAImH,GACJA,EAAM,IAAInI,EAAWoI,gBACjB2I,mBAAqB,WACA,IAAnB5I,EAAI6I,YACNhQ,EAAQ,CACNwH,OAAQL,EAAIK,OACZS,KAAMpE,KAAK4D,YAIjBN,EAAIE,KAAK,MAAON,GAAK,GACrBI,EAAI2I,gBAAkBA,EACtB7P,EAAS0B,KAAKkO,EAAS,SAAUtQ,EAAOgQ,GACtCpI,EAAI8I,iBAAiBV,EAAKhQ,KAE5B4H,EAAIG,aAAe,OACnBH,EAAIY,UAyBNmI,UAZc,SAAUC,GACxB,IAAIf,EACJ,IACEA,EAAOgB,KAAKC,MAAMF,GAClB,MAAOpK,IAET,OAAOqJ,IASLkB,EAAqB,CACvB,CACEzI,KAAM,IACN0I,QAAS,8BAEX,CACE1I,KAAM,IACN0I,QAAS,oBAEX,CACE1I,KAAM,EACN0I,QAAS,8BAGTC,EAAwB,CAC1B,CACE9H,KAAM,cACN6H,QAAS,2CAEX,CACE7H,KAAM,gBACN6H,QAAS,4CAEX,CACE7H,KAAM,qBACN6H,QAAS,sDAMTE,EAAkB,SAAUjJ,GAM9B,MAAO,0BALOqH,EAAKyB,EAAoB,SAAU7H,GAC/C,OAAOjB,IAAWiB,EAAMZ,OACvBnH,KAAKP,EAAS,4BAA6B,SAAUsI,GACtD,OAAOA,EAAM8H,WAIbG,EAAkB,SAAUlJ,GAC9B,IAAI+I,EAAUE,EAAgBjJ,GAC9B,OAAO2F,EAAShJ,OAAOoM,IAErBI,EAAqB,SAAUjI,GACjC,OAAOmG,EAAK2B,EAAuB,SAAU/H,GAC3C,OAAOA,EAAMC,OAASA,IACrBhI,KAAKP,EAAS,yBAA0B,SAAUsI,GACnD,OAAOA,EAAM8H,WAYbK,EAAqB,SAAUpJ,EAAQS,GACzC,OAAOiH,EAAMM,SAASvH,GAAM1C,KAAK,SAAU4K,GACzC,IAAIU,EAXc,SAAUV,GAC9B,IAAIU,EAAe3B,EAAMgB,UAAUC,GAC/BW,EAAY5B,EAAMC,SAAS0B,EAAc,CAC3C,QACA,SAGF,MAAO,8BADQC,EAAYH,EAAmBG,GAAa,yCAKtCC,CAAgBZ,GACnC,OAAOhD,EAAShJ,OAAO0M,MAMvBG,EAAS,CACXC,2BAJ+B,SAAUzJ,EAAQS,GACjD,OArCgB,OADiBJ,EAsCPL,IArCM,MAATK,GAAyB,MAATA,EAqCH+I,EAAmBpJ,EAAQS,GAAQyI,EAAgBlJ,GAtChE,IAAUK,GA0CjC6I,gBAAiBA,EACjBD,gBAAiBA,EACjBE,mBAAoBA,GAWlBO,EAAqB,SAAUnK,EAAKoK,GACtC,IAAItB,EAAU,CACZuB,eAAgB,iCAChBC,eAAgBF,GAElB,OAAOjC,EAAMU,iBAbI,SAAU7I,EAAKoK,GAChC,IAAIG,GAAkC,IAAtBvK,EAAIE,QAAQ,KAAc,IAAM,IAChD,MAAI,cAAc2G,KAAK7G,KAASoK,EACvBpK,EAEAA,EAAMuK,EAAY,UAAYC,mBAAmBJ,GAQ5BK,CAAazK,EAAKoK,GAAStB,GAAS,GAAOtK,KAAK,SAAUyG,GACtF,OAAOA,EAAOxE,OAAS,KAAOwE,EAAOxE,QAAU,IAAMwJ,EAAOC,2BAA2BjF,EAAOxE,OAAQwE,EAAO/D,MAAQkF,EAASnN,QAAQgM,EAAO/D,SAQjJ,IAAIwJ,EAAS,SAAU1K,EAAKoK,EAAQrB,GAClC,OAAOqB,EAASD,EAAmBnK,EAAKoK,GAN1C,SAAqBpK,EAAK+I,GACxB,OAAOZ,EAAMU,iBAAiB7I,EAAK,GAAI+I,GAAiBvK,KAAK,SAAUyG,GACrE,OAAOA,EAAOxE,OAAS,KAAOwE,EAAOxE,QAAU,IAAMwJ,EAAON,gBAAgB1E,EAAOxE,QAAU2F,EAASnN,QAAQgM,EAAO/D,QAIrEyJ,CAAY3K,EAAK+I,IAGjE6B,EAA0B,SAAUpP,EAAGK,EAAGgP,GAC5C,OAAkD,IAA1CrP,EAAEoP,wBAAwB/O,GAAKgP,IAQrCC,EAH8B,SAAUtP,EAAGK,GAC7C,OAAO+O,EAAwBpP,EAAGK,EAAG5D,EAAW6S,KAAKC,iCAoCnDC,GAAU,WACZ,OAAOC,GAAG,EAAG,IAEXA,GAAK,SAAUC,EAAOC,GACxB,MAAO,CACLD,MAAOA,EACPC,MAAOA,IAGPC,GAAU,CACZH,GAAIA,GACJI,OAlBW,SAAUC,EAAgBC,GACrC,IAAIC,EAAe7D,OAAO4D,GAAOE,cACjC,OAA8B,IAA1BH,EAAe1M,OACVoM,KAhBE,SAAUU,EAASH,GAC9B,IAAII,EAVW,SAAUD,EAAS7R,GAClC,IAAK,IAAI2F,EAAI,EAAGA,EAAIkM,EAAQ9M,OAAQY,IAAK,CACvC,IAAIgI,EAAIkE,EAAQlM,GAChB,GAAIgI,EAAEX,KAAKhN,GACT,OAAO2N,GAMHoE,CAAWF,EAASH,GAC5B,IAAKI,EACH,MAAO,CACLT,MAAO,EACPC,MAAO,GAGX,IAAIU,EAAQ,SAAUrM,GACpB,OAAOsM,OAAOP,EAAMQ,QAAQJ,EAAG,IAAMnM,KAEvC,OAAOyL,GAAGY,EAAM,GAAIA,EAAM,IAOnBG,CAAOV,EAAgBE,IAc9BR,QAASA,IASPiB,GAAY,SAAUlL,EAAMmL,GAC9B,OAAO,WACL,OAAOA,IAAYnL,IASnBoL,GAAO,SAAUC,GACnB,IAAIF,EAAUE,EAAKF,QAEnB,MAAO,CACLA,QAASA,EACTG,QAHYD,EAAKC,QAIjBC,OAAQL,GAvBD,OAuBiBC,GACxBK,SAAUN,GAvBD,SAuBmBC,GAC5BM,KAAMP,GAvBD,KAuBeC,GACpBO,QAASR,GAvBD,QAuBkBC,GAC1BQ,UAAWT,GAvBD,UAuBoBC,GAC9BS,SAAUV,GAvBD,SAuBmBC,KAG5BU,GAAU,CACZ5B,QArBc,WACd,OAAOmB,GAAK,CACVD,aAAS1R,EACT6R,QAASjB,GAAQJ,aAmBnBC,GAAIkB,GACJU,KAAMzT,EAlCG,QAmCT0T,OAAQ1T,EAlCG,UAmCX2T,GAAI3T,EAlCG,MAmCP4T,MAAO5T,EAlCG,SAmCV6T,QAAS7T,EAlCG,WAmCZ8T,OAAQ9T,EAlCG,WA4CT+T,GAAO,SAAUpM,EAAMmL,GACzB,OAAO,WACL,OAAOA,IAAYnL,IASnBqM,GAAO,SAAUhB,GACnB,IAAIF,EAAUE,EAAKF,QAEnB,MAAO,CACLA,QAASA,EACTG,QAHYD,EAAKC,QAIjBgB,UAAWF,GAxBD,UAwBejB,GACzBoB,MAAOH,GAxBD,MAwBWjB,GACjBqB,UAAWJ,GAxBD,UAwBejB,GACzBsB,MAAOL,GAvBD,MAuBWjB,GACjBuB,QAASN,GAzBD,QAyBajB,GACrBwB,UAAWP,GAxBD,UAwBejB,GACzByB,UAAWR,GAxBD,UAwBejB,KAGzB0B,GAAkB,CACpB5C,QAtBc,WACd,OAAOoC,GAAK,CACVlB,aAAS1R,EACT6R,QAASjB,GAAQJ,aAoBnBC,GAAImC,GACJS,QAASzU,EApCG,WAqCZ0U,IAAK1U,EApCG,OAqCR2U,QAAS3U,EApCG,WAqCZ4U,MAAO5U,EApCG,SAqCV6U,IAAK7U,EApCG,OAqCR8U,QAAS9U,EApCG,WAqCZ+U,QAAS/U,EApCG,YA6DVgV,GAAW,SAAUC,EAAYC,GACnC,IAAI/C,EAAQ5D,OAAO2G,GAAW7C,cAC9B,OAAO3D,EAAKuG,EAAY,SAAUE,GAChC,OAAOA,EAAUC,OAAOjD,MAqBxBkD,GAlBgB,SAAUC,EAAUJ,GACtC,OAAOF,GAASM,EAAUJ,GAAW3T,IAAI,SAAUgU,GACjD,IAAItC,EAAUjB,GAAQC,OAAOsD,EAAQrD,eAAgBgD,GACrD,MAAO,CACLpC,QAASyC,EAAQ5N,KACjBsL,QAASA,MAaXoC,GATW,SAAUG,EAAMN,GAC7B,OAAOF,GAASQ,EAAMN,GAAW3T,IAAI,SAAUkU,GAC7C,IAAIxC,EAAUjB,GAAQC,OAAOwD,EAAGvD,eAAgBgD,GAChD,MAAO,CACLpC,QAAS2C,EAAG9N,KACZsL,QAASA,MASXyC,GAAW,SAAUC,EAAKC,GAC5B,OAAgC,IAAzBD,EAAI7O,QAAQ8O,IAGjBC,GAAqB,sCACrBC,GAAgB,SAAUvG,GAC5B,OAAO,SAAUwG,GACf,OAAOL,GAASK,EAAUxG,KAG1B+F,GAAW,CACb,CACE3N,KAAM,OACNuK,eAAgB,CAAC,kCACjBkD,OAAQ,SAAUW,GAChB,OAAOL,GAASK,EAAU,UAAYL,GAASK,EAAU,WAAaL,GAASK,EAAU,WAAaL,GAASK,EAAU,iBAG7H,CACEpO,KAAM,SACNuK,eAAgB,CACd,kCACA2D,IAEFT,OAAQ,SAAUW,GAChB,OAAOL,GAASK,EAAU,YAAcL,GAASK,EAAU,iBAG/D,CACEpO,KAAM,KACNuK,eAAgB,CACd,iCACA,8BAEFkD,OAAQ,SAAUW,GAChB,OAAOL,GAASK,EAAU,SAAWL,GAASK,EAAU,aAG5D,CACEpO,KAAM,QACNuK,eAAgB,CACd2D,GACA,kCAEFT,OAAQU,GAAc,UAExB,CACEnO,KAAM,UACNuK,eAAgB,CAAC,uCACjBkD,OAAQU,GAAc,YAExB,CACEnO,KAAM,SACNuK,eAAgB,CACd2D,GACA,iCAEFT,OAAQ,SAAUW,GAChB,OAAQL,GAASK,EAAU,WAAaL,GAASK,EAAU,aAAeL,GAASK,EAAU,kBAI/FP,GAAO,CACT,CACE7N,KAAM,UACNyN,OAAQU,GAAc,OACtB5D,eAAgB,CAAC,0CAEnB,CACEvK,KAAM,MACNyN,OAAQ,SAAUW,GAChB,OAAOL,GAASK,EAAU,WAAaL,GAASK,EAAU,SAE5D7D,eAAgB,CACd,sCACA,+BACA,wCAGJ,CACEvK,KAAM,UACNyN,OAAQU,GAAc,WACtB5D,eAAgB,CAAC,sCAEnB,CACEvK,KAAM,MACNyN,OAAQU,GAAc,QACtB5D,eAAgB,CAAC,mCAEnB,CACEvK,KAAM,QACNyN,OAAQU,GAAc,SACtB5D,eAAgB,IAElB,CACEvK,KAAM,UACNyN,OAAQU,GAAc,SACtB5D,eAAgB,IAElB,CACEvK,KAAM,UACNyN,OAAQU,GAAc,WACtB5D,eAAgB,KAGhB8D,GAAe,CACjBV,SAAUtV,EAASsV,IACnBE,KAAMxV,EAASwV,KAebS,GAZW,SAAUf,EAAWgB,GAClC,IAAIZ,EAAWU,GAAaV,WACxBE,EAAOQ,GAAaR,OACpBD,EAAUF,GAAuBC,EAAUJ,GAAW3U,KAAKiT,GAAQ5B,QAAS4B,GAAQ3B,IACpF4D,EAAKJ,GAAkBG,EAAMN,GAAW3U,KAAKiU,GAAgB5C,QAAS4C,GAAgB3C,IACtFsE,EAtKW,SAAUV,EAAIF,EAASL,EAAWgB,GACjD,IAAIE,EAASX,EAAGvB,UAAuC,IAA5B,QAAQzG,KAAKyH,GACpCmB,EAAWZ,EAAGvB,UAAYkC,EAC1BE,EAAWb,EAAGvB,SAAWuB,EAAGtB,YAC5BoC,EAAUD,GAAYJ,EAAW,oBACjCM,EAAWJ,IAAWC,GAAYC,GAAYJ,EAAW,4BACzDO,EAAUJ,GAAYC,IAAaE,EACnCE,EAAanB,EAAQhC,YAAckC,EAAGvB,UAAyC,IAA9B,UAAUzG,KAAKyH,GAChEyB,GAAaF,IAAYD,IAAaE,EAC1C,MAAO,CACLN,OAAQpW,EAASoW,GACjBC,SAAUrW,EAASqW,GACnBG,SAAUxW,EAASwW,GACnBC,QAASzW,EAASyW,GAClBF,QAASvW,EAASuW,GAClBpC,UAAWsB,EAAGtB,UACdD,MAAOuB,EAAGvB,MACV0C,UAAW5W,EAAS0W,GACpBC,UAAW3W,EAAS2W,IAoJLE,CAAWpB,EAAIF,EAASL,EAAWgB,GACpD,MAAO,CACLX,QAASA,EACTE,GAAIA,EACJU,WAAYA,IAQZW,GAAW5X,EAAK+W,GAAyBpX,EAAWkY,UAAU7B,UAHjD,SAAU8B,GACzB,OAAOnY,EAAW2E,OAAOyT,WAAWD,GAAOnO,WA2BzCqO,GAAU,SAAUC,GACtB,GAAIA,MAAAA,EACF,MAAM,IAAIlW,MAAM,oCAElB,MAAO,CAAEmW,IAAKpX,EAASmX,KAMrBE,GAAU,CACZC,SA/Ba,SAAUC,EAAMC,GAC7B,IACIC,GADMD,GAAS3Y,EAAWmE,UAChBC,cAAc,OAE5B,GADAwU,EAAIC,UAAYH,GACXE,EAAIE,iBAAmBF,EAAIG,WAAWpS,OAAS,EAElD,MADA3G,EAAWgZ,QAAQvP,MAAM,wCAAyCiP,GAC5D,IAAItW,MAAM,qCAElB,OAAOiW,GAAQO,EAAIG,WAAW,KAwB9BE,QAtBY,SAAUC,EAAKP,GAC3B,IACIL,GADMK,GAAS3Y,EAAWmE,UACfC,cAAc8U,GAC7B,OAAOb,GAAQC,IAoBfa,SAlBa,SAAUhI,EAAMwH,GAC7B,IACIL,GADMK,GAAS3Y,EAAWmE,UACfiV,eAAejI,GAC9B,OAAOkH,GAAQC,IAgBfD,QAASA,GACTgB,UATc,SAAUC,EAAQ/J,EAAGgK,GACnC,IAAIC,EAAMF,EAAOf,MACjB,OAAO1U,EAAOC,KAAK0V,EAAIC,iBAAiBlK,EAAGgK,IAAI7W,IAAI2V,MAgBjDqB,IANY1Z,EAAW6S,KAAK8G,eACZ3Z,EAAW6S,KAAK+G,mBACtB5Z,EAAW6S,KAAKgH,aACf7Z,EAAW6S,KAAKiH,cACX9Z,EAAW6S,KAAKkH,mBACZ/Z,EAAW6S,KAAKmH,uBAC1Bha,EAAW6S,KAAKoH,cAO1BC,IANOla,EAAW6S,KAAKsH,UACEna,EAAW6S,KAAKuH,4BACtBpa,EAAW6S,KAAKwH,sBAC1Bra,EAAW6S,KAAKyH,YACdta,EAAW6S,KAAK0H,cAEfb,IA0CZc,IAhGKvC,GAASzX,MAmFOkW,QACAnC,YAEiB,IAAtBvU,EAAW2E,OAAyB3E,EAAW2E,OAAS8V,SAAS,eAATA,GAU9D,SAAU9B,EAAO+B,GAC7B,OATU,SAAU/B,EAAOgC,GAK3B,OADa9K,EAAK8I,EAAMJ,MAAMQ,WAHnB,SAAUT,GACnB,OAAOqC,EAAUnC,GAAQH,QAAQC,MAGrB5V,IAAI8V,GAAQH,SAInBuC,CAAMjC,EAAO,SAAUvS,GAC5B,OA3CK,SAAUyU,EAASH,GAC1B,IAAInC,EAAMsC,EAAQtC,MAClB,GAAIA,EAAIuC,WAAaZ,GACnB,OAAO,EAEP,IAAIa,EAAOxC,EACX,QAAqBhW,IAAjBwY,EAAK/Q,QACP,OAAO+Q,EAAK/Q,QAAQ0Q,GACf,QAA+BnY,IAA3BwY,EAAKC,kBACd,OAAOD,EAAKC,kBAAkBN,GACzB,QAAmCnY,IAA/BwY,EAAKE,sBACd,OAAOF,EAAKE,sBAAsBP,GAC7B,QAAgCnY,IAA5BwY,EAAKG,mBACd,OAAOH,EAAKG,mBAAmBR,GAE/B,MAAM,IAAItY,MAAM,kCA4BXP,CAAGuE,EAAGsU,OAIbS,GAAQ,EACRC,GAAe,SAAUL,GAC3B,OAAOP,GAAQhC,GAAQH,QAAQ0C,GAAO,QAEpCM,GAAW,SAAU/M,EAAQyM,GAC/B,OAAOzM,EAAOiK,IAAI1W,GAAGkZ,EAAM,WAiBzBO,GAAe,SAAUhN,EAAQ7E,GACnC6E,EAAOiN,oBAAoBlT,KAAK,CAC9B8I,KAAM1H,EACNC,KAAM,WAGN8R,GAAmB,SAAUlN,GAC/B,IAAIyM,EAAOzM,EAAOmN,UAAUC,UAC5B,OAAIL,GAAS/M,EAAQyM,GACZK,GAAaL,GAEblX,EAAOP,KAAKkV,GAAQH,QAAQ0C,KAanCY,GAAe,SAAUrN,EAAQI,GACnC,IAAI3G,EAAM2G,EAAI1G,IACd,OAAgC,IAAzBD,EAAIE,QAAQ,UAA2C,IAAzBF,EAAIE,QAAQ,UAAkB,IAAImG,EAASrG,GAAK6T,OAAStN,EAAOuN,gBAAgBD,MAEnHE,GAAc,SAAUxN,EAAQI,GAClC,OAA+E,IAAxEzN,EAAS8a,QAxuBC,SAAUzN,GAC3B,OAAOA,EAAOC,SAAS,wBAAyB,GAAI,YAuuB5ByN,CAAa1N,GAAS,IAAIF,EAASM,EAAI1G,KAAK4T,OAKlEK,GAAoB,SAAU3N,EAAQI,GACxC,IAAmByD,EAAfnK,EAAM0G,EAAI1G,IACd,OAAI8T,GAAYxN,EAAQI,GACf+D,EAAO/D,EAAI1G,IAAK,KANM,SAAUsG,EAAQI,GACjD,OAAsF,IAA/EzN,EAAS8a,QAxuBQ,SAAUzN,GAClC,OAAOA,EAAOC,SAAS,+BAAgC,GAAI,YAuuBnC2N,CAAoB5N,GAAS,IAAIF,EAASM,EAAI1G,KAAK4T,MAK5CO,CAA2B7N,EAAQI,IAE7DiN,GAAarN,EAAQI,GA32BnB7G,EAi3Bc6G,IALnB1G,EAtvBc,SAAUsG,GAC1B,OAAOA,EAAOC,SAAS,oBAqvBf6N,CAAY9N,GAClBtG,KAA8B,IAAtBA,EAAIC,QAAQ,KAAc,IAAM,KAAO,OAASsK,mBAAmB7D,EAAI1G,KAC/EmK,EA5uBY,SAAU7D,GACxB,OAAOA,EAAOC,SAAS,UAAWD,EAAOC,SAAS,qBAAsB,GAAI,UAAW,UA2uB5E8N,CAAU/N,GACZmE,EAAOzK,EAAKmK,GAAQ,KAI3BmK,GAAgB,SAAUhO,EAAQI,GACpC,OArvBkB,SAAUJ,GAC5B,OAAOzK,EAAOC,KAAKwK,EAAOC,SAAS,yBAA0B,KAAM,aAovB5DgO,CAAcjO,GAAQ5M,KAAK,WAChC,OAAOua,GAAkB3N,EAAQI,IAChC,SAAU8N,GACX,OAAOA,EAAiB9N,MAGxB+N,GAAW,SAAUnO,EAAQI,GAC/B,IAAIgO,EAEJ,OADAA,EAAWpO,EAAOqO,aAAaC,UAAUC,SAASnO,EAAI1G,MAE7CmG,EAASnN,QAAQ0b,EAASzT,QAE5BqT,GAAchO,EAAQI,IAE3BoO,GAAmB,SAAUxO,EAAQyO,GACvC,IAAIC,EAAmB9O,EAAS+O,iBAAiB3O,EAAQ,WACvDA,EAAOqO,aAAaO,oBA/vBD,SAAU5O,GAC/B,OAAOA,EAAOC,SAAS,wBAAyB,IAAO,UA+vBpD4O,CAAiB7O,IACpByO,EAAsBtc,IAAIuc,IAExBI,GAAoB,SAAUL,GAChC7O,EAASmP,aAAaN,EAAsBvc,QAE1C8c,GAAsB,SAAUhP,EAAQjB,EAAIkQ,EAAmBR,EAAuBS,EAAetO,GACvG,OAAO7B,EAAG7B,SAASjF,KAAK,SAAU0C,GAChC,IAAIY,EAAKf,EAAM8T,EAAWF,EAwC1B,OAvCAE,EAAYtO,EAAOqO,aAAaC,UAChC/S,EAAM2T,EAAcxV,IAvwBE,SAAUsG,GAClC,OAAOA,EAAOC,SAAS,yBAAyB,EAAO,WAuwBjDkP,CAAoBnP,MACtBoO,EAAWE,EAAUC,SAAShT,KAE5BA,EAAM6S,EAAS7S,MACff,EAAO4T,EAAS5T,QAEhBA,EApEc,SAAUwF,EAAQvG,GACtC,IAAI2V,EAAI3V,EAAI6K,MAAM,gDAClB,OAAI8K,EACKpP,EAAOiK,IAAIoF,OAAOD,EAAE,IAEtB,KA+DME,CAAgBtP,EAAQzE,IAGnC6S,EAAWE,EAAU7Y,OAAO,CAC1B5D,GAhEG,aAAegb,KAiElBlS,KAAMA,EACNkB,OAAQkD,EAAGd,WACX1C,IAAKA,EACLf,KAAMA,IAER8T,EAAUiB,IAAInB,GACdpO,EAAOwP,YAAYC,SAAS,WAW1BzP,EAAO0P,EAAER,GAAeS,GAAG,OAV3B,SAASC,IACP5P,EAAO0P,EAAER,GAAeW,IAAI,OAAQD,GACpC5P,EAAO8P,cACHb,EACFjP,EAAOqO,aAAaO,oBAEpBE,GAAkBL,GAClBD,GAAiBxO,EAAQyO,MAIzB7N,GACFZ,EAAO0P,EAAER,GAAea,KAAK,CAC3Bra,MAAOkL,EAAKJ,EACZ7K,OAAQiL,EAAKF,IAGjBV,EAAO0P,EAAER,GAAea,KAAK,CAAErW,IAAK0U,EAAS4B,YAAaC,WAAW,kBAEhE7B,KAGP8B,GAAyB,SAAUlQ,EAAQyO,EAAuBnY,EAAIsK,GACxE,OAAO,WAEL,OADasM,GAAiBlN,GAChB5M,KAAK,WACjB4Z,GAAahN,EAAQ,kCACpB,SAAUI,GACX,OAAOJ,EAAOmQ,iBAAiBlY,KAAK,WAClC,OAAOkW,GAASnO,EAAQI,EAAI6J,SAC3BhS,KAAK0H,GAAmB1H,KAAK3B,GAAI2B,KAAK,SAAUmY,GACjD,OAAOpB,GAAoBhP,EAAQoQ,GAAa,EAAO3B,EAAuBrO,EAAI6J,MAAOrJ,IACxF,SAAUzF,GACX6R,GAAahN,EAAQ7E,SA8CzBkV,GAAU,CACZvR,OA1Ca,SAAUkB,EAAQyO,EAAuBzP,GACtD,OAAO,WACL,IACIsR,EADSpD,GAAiBlN,GACL5M,KAAK,WAC5B,OAAO,MACN,SAAUgN,GACX,IAAIQ,EAAOV,EAAUC,aAAaC,EAAI6J,OACtC,OAAOrJ,EAAO,CACZJ,EAAGI,EAAKF,EACRA,EAAGE,EAAKJ,GACN,OAEN,OAAO0P,GAAuBlQ,EAAQyO,EAAuB,SAAU2B,GACrE,OAh3BS,SAAUrR,EAAIC,GAC3B,OAAOF,EAAOC,EAAIC,GA+2BPuR,CAASH,EAAapR,IAC5BsR,EAFIJ,KA+BT3Q,KA1BW,SAAUS,EAAQyO,EAAuBjP,GACpD,OAAO,WACL,OAAO0Q,GAAuBlQ,EAAQyO,EAAuB,SAAU2B,GACrE,OA13BO,SAAUrR,EAAIS,GACzB,OAAOD,EAAKR,EAAIS,GAy3BLgR,CAAOJ,EAAa5Q,IADtB0Q,KAyBTO,iBA/LqB,SAAUzQ,EAAQyM,GACvC,IAGIiE,EAAa,SAAUC,GACzB,OAJY,SAAUA,GACtB,OAAO3Q,EAAOiK,IAAI1W,GAAGod,EAAS,qDAGvBC,CAAQD,KAAatD,GAAarN,EAAQ2Q,IAAYnD,GAAYxN,EAAQ2Q,IAAY3Q,EAAO6Q,SAASC,mBAE/G,OAAI/D,GAAS/M,EAAQyM,GACNK,GAAaL,GACZrY,IAAI,SAAUgM,GAC1B,OAAOsQ,EAAWtQ,EAAI6J,OAAS1U,EAAOP,KAAKoL,EAAI6J,OAAS1U,EAAOvC,SAG5D0d,EAAWjE,GAAQlX,EAAOP,KAAKyX,GAAQlX,EAAOvC,QAmLrD8b,kBAAmBA,GACnBX,SAAUA,GACVjB,iBAAkBA,GAClB6D,iBAxBqB,SAAU/Q,EAAQyO,EAAuBrO,EAAK4Q,EAAcrW,GACjF,OAAO,IAAIkF,EAAS,SAAUnN,IAr+BZ,SAAUiI,GAC5B,OAAOD,EAAYC,IAq+BjBsW,CAActW,GAAM1C,KAAK,SAAUiZ,GACjC,IAAIC,EAAUjR,EAAUa,oBAAoBmQ,GAO5C,OANIF,EAAaxQ,IAAM2Q,EAAQ3Q,GAAKwQ,EAAatQ,IAAMyQ,EAAQzQ,GACzDR,EAAUC,aAAaC,IACzBF,EAAUS,aAAaP,EAAK+Q,GAGhCzf,EAAWmJ,IAAIwC,gBAAgB6T,EAASxX,KACjCiB,IACN1C,KAAK0H,GAAmB1H,KAAK,SAAUmY,GACxC,OAAOpB,GAAoBhP,EAAQoQ,GAAa,EAAM3B,EAAuBrO,IAC5E,kBAcHgR,GAAYve,EAAS,cACrBwe,GAAUxe,EAAS,WACnBye,GAASze,EAAS,UAmFlB0e,GA3EW,SAAUvR,EAAQyO,GAC/B,OAAO,WACL,IA0DI+C,EAAiBnB,GAAQnD,iBAAiBlN,GAC1CyR,EAAkBD,EAAepd,IAAI,SAAUsd,GACjD,OAAOxR,EAAUa,oBAAoB2Q,EAAQzH,SAElCoG,GAAQnD,iBAAiBlN,GAC/B3L,KAAK,SAAU+L,GACpBiQ,GAAQI,iBAAiBzQ,EAAQI,EAAI6J,OAAO5V,KAAK,SAAUsd,GACzDtB,GAAQlC,SAASnO,EAAQI,EAAI6J,OAAOhS,KAAK,SAAU0C,GACjD,IAAIiX,EA1EI,SAAUjX,GAC1B,MAAO,CACLA,KAAMA,EACNlB,IAAK/H,EAAWmJ,IAAIC,gBAAgBH,IAuElBkX,CAAYlX,GACxBqF,EAAO8R,cAAc/X,KAlElB,CACLgY,MAAO,aACPnR,KAAM,QACNoR,KAAM,CACJ5W,KAAM,QACN6W,MAAO,CAAC,CACJ7W,KAAM,aACNZ,KAAM,aACN0X,MAAO,aACPC,aAyDoCP,KAtD1CQ,QAAS,CACP,CACEhX,KAAM,SACNZ,KAAM,SACNqI,KAAM,UAER,CACEzH,KAAM,SACNZ,KAAM,OACNqI,KAAM,OACNwP,SAAS,EACTC,UAAU,IAGdC,SAAU,SAAUC,GAClB,IAAI7X,EAAO6X,EAAIC,UAAUC,WAAW/X,KACpC6W,EAAend,KAAK,SAAUse,GAC5BlB,EAAgBpd,KAAK,SAAU2c,GAC7BX,GAAQU,iBAAiB/Q,EAAQyO,EAAuBkE,EAAY1I,MAAO+G,EAAcrW,OAG7F6X,EAAII,SAENC,SAAU,aAEVC,SAAU,SAAUN,EAAKO,GACvB,OAAQA,EAAQvY,MAChB,KAAK4W,KACC2B,EAAQ9gB,MACVugB,EAAIlB,OAAO,QAEXkB,EAAInB,QAAQ,QAEd,MACF,KAAKA,KACHmB,EAAInB,QAAQ,QACZmB,EAAInB,QAAQ,UACZ,MACF,KAAKC,KACHkB,EAAIlB,OAAO,sBAkCnB0B,GAAW,CAAEC,SAXF,SAAUjT,EAAQyO,GAC/B9b,EAAS0B,KAAK,CACZ6e,mBAAoB7C,GAAQvR,OAAOkB,EAAQyO,GAAwB,IACnE0E,oBAAqB9C,GAAQvR,OAAOkB,EAAQyO,EAAuB,IACnE2E,qBAAsB/C,GAAQ9Q,KAAKS,EAAQyO,EAAuB,KAClE4E,uBAAwBhD,GAAQ9Q,KAAKS,EAAQyO,EAAuB,KACpE6E,aAAc/B,GAAgBvR,EAAQyO,IACrC,SAAUnY,EAAIid,GACfvT,EAAOwT,WAAWD,EAAKjd,OAgBvBmd,GAAsB,CAAEC,MAXhB,SAAU1T,EAAQyO,EAAuBkF,GACnD3T,EAAO2P,GAAG,aAAc,SAAU7X,GAChC,IAAI8b,EAAoBD,EAAuBzhB,MAC3C0hB,GAAqBA,EAAkBla,MAAQ5B,EAAEyU,QAAQ7S,MAC3D2W,GAAQvB,kBAAkBL,GAC1BzO,EAAOqO,aAAaO,mBACpB+E,EAAuBxhB,IAAI,OAE7Bke,GAAQI,iBAAiBzQ,EAAQlI,EAAEyU,SAASlY,KAAKsf,EAAuBxhB,SAoExE0hB,GAAU,CAAEZ,SA/DC,SAAUjT,GACzB,IAAIuT,EAAM,SAAUO,GAClB,OAAO,WACL,OAAO9T,EAAO+T,YAAYD,KAG9B9T,EAAOgU,GAAGC,SAASC,UAAU,aAAc,CACzCC,QAAS,0BACTC,KAAM,cACNtB,SAAUS,EAAI,wBAEhBvT,EAAOgU,GAAGC,SAASC,UAAU,cAAe,CAC1CC,QAAS,mBACTC,KAAM,eACNtB,SAAUS,EAAI,yBAEhBvT,EAAOgU,GAAGC,SAASC,UAAU,QAAS,CACpCC,QAAS,kBACTC,KAAM,kBACNtB,SAAUS,EAAI,0BAEhBvT,EAAOgU,GAAGC,SAASC,UAAU,QAAS,CACpCC,QAAS,oBACTC,KAAM,oBACNtB,SAAUS,EAAI,4BAEhBvT,EAAOgU,GAAGC,SAASC,UAAU,YAAa,CACxCC,QAAS,aACTC,KAAM,aACNtB,SAAUS,EAAI,gBACdc,QAAS,SAAUC,GACjB,IAAIC,EAAc,WACClE,GAAQnD,iBAAiBlN,GAC/B3L,KAAK,SAAUkY,GACxB,IAAI+F,EAAWjC,GAAQI,iBAAiBzQ,EAAQuM,EAAQtC,OAAO9W,SAC/DmhB,EAAUC,YAAYjC,MAI1B,OADAtS,EAAO2P,GAAG,aAAc4E,GACjB,WACLvU,EAAO6P,IAAI,aAAc0E,OAI/BvU,EAAOgU,GAAGC,SAASC,UAAU,eAAgB,CAC3CC,QAAS,gBACTC,KAAM,gBACNtB,SAAUS,EAAI,cAEhBvT,EAAOgU,GAAGC,SAASO,eAAe,aAAc,CAC9CC,OAAQ,SAAUlI,GAChB,OAAO8D,GAAQI,iBAAiBzQ,EAAQuM,GAASnZ,KAAK,WACpD,MAAO,IACN,SAAUue,GACX,MAAO,CAAC,CACJ9O,KAAM,aACNuR,KAAM,aACNtB,SAAUS,EAAI,yBAkBtBmB,GAAiB,CAAEzB,SAVN,SAAUjT,GACzBA,EAAOgU,GAAGC,SAASU,kBAAkB,aAAc,CACjD1C,MAAOlS,EAAgBC,GACvBqM,UAAW,SAAUI,GACnB,OAAO4D,GAAQI,iBAAiBzQ,EAAQyM,GAAMjZ,UAEhDohB,SAAU,OACVvK,MAAO,WAMT/X,EAAOid,IAAI,aAAc,SAAUvP,GACjC,IAAIyO,EAAwB1c,EAAK,GAC7B4hB,EAAyB5hB,EAAK,MAClCihB,GAASC,SAASjT,EAAQyO,GAC1BoF,GAAQZ,SAASjT,GACjB0U,GAAezB,SAASjT,GACxByT,GAAoBC,MAAM1T,EAAQyO,EAAuBkF,KA/pDjE,CAqqDEtd","file":"plugin.js","sourcesContent":["/**\n * Copyright (c) Tiny Technologies, Inc. All rights reserved.\n * Licensed under the LGPL or a commercial license.\n * For LGPL see License.txt in the project root for license information.\n * For commercial licenses see https://www.tiny.cloud/\n *\n * Version: 5.1.0 (2019-10-17)\n */\n(function (domGlobals) {\n    'use strict';\n\n    var Cell = function (initial) {\n      var value = initial;\n      var get = function () {\n        return value;\n      };\n      var set = function (v) {\n        value = v;\n      };\n      var clone = function () {\n        return Cell(get());\n      };\n      return {\n        get: get,\n        set: set,\n        clone: clone\n      };\n    };\n\n    var global = tinymce.util.Tools.resolve('tinymce.PluginManager');\n\n    var global$1 = tinymce.util.Tools.resolve('tinymce.util.Tools');\n\n    var noop = function () {\n    };\n    var constant = function (value) {\n      return function () {\n        return value;\n      };\n    };\n    var never = constant(false);\n    var always = constant(true);\n\n    var none = function () {\n      return NONE;\n    };\n    var NONE = function () {\n      var eq = function (o) {\n        return o.isNone();\n      };\n      var call = function (thunk) {\n        return thunk();\n      };\n      var id = function (n) {\n        return n;\n      };\n      var me = {\n        fold: function (n, s) {\n          return n();\n        },\n        is: never,\n        isSome: never,\n        isNone: always,\n        getOr: id,\n        getOrThunk: call,\n        getOrDie: function (msg) {\n          throw new Error(msg || 'error: getOrDie called on none.');\n        },\n        getOrNull: constant(null),\n        getOrUndefined: constant(undefined),\n        or: id,\n        orThunk: call,\n        map: none,\n        each: noop,\n        bind: none,\n        exists: never,\n        forall: always,\n        filter: none,\n        equals: eq,\n        equals_: eq,\n        toArray: function () {\n          return [];\n        },\n        toString: constant('none()')\n      };\n      if (Object.freeze) {\n        Object.freeze(me);\n      }\n      return me;\n    }();\n    var some = function (a) {\n      var constant_a = constant(a);\n      var self = function () {\n        return me;\n      };\n      var bind = function (f) {\n        return f(a);\n      };\n      var me = {\n        fold: function (n, s) {\n          return s(a);\n        },\n        is: function (v) {\n          return a === v;\n        },\n        isSome: always,\n        isNone: never,\n        getOr: constant_a,\n        getOrThunk: constant_a,\n        getOrDie: constant_a,\n        getOrNull: constant_a,\n        getOrUndefined: constant_a,\n        or: self,\n        orThunk: self,\n        map: function (f) {\n          return some(f(a));\n        },\n        each: function (f) {\n          f(a);\n        },\n        bind: bind,\n        exists: bind,\n        forall: bind,\n        filter: function (f) {\n          return f(a) ? me : NONE;\n        },\n        toArray: function () {\n          return [a];\n        },\n        toString: function () {\n          return 'some(' + a + ')';\n        },\n        equals: function (o) {\n          return o.is(a);\n        },\n        equals_: function (o, elementEq) {\n          return o.fold(never, function (b) {\n            return elementEq(a, b);\n          });\n        }\n      };\n      return me;\n    };\n    var from = function (value) {\n      return value === null || value === undefined ? NONE : some(value);\n    };\n    var Option = {\n      some: some,\n      none: none,\n      from: from\n    };\n\n    function create(width, height) {\n      return resize(domGlobals.document.createElement('canvas'), width, height);\n    }\n    function clone(canvas) {\n      var tCanvas = create(canvas.width, canvas.height);\n      var ctx = get2dContext(tCanvas);\n      ctx.drawImage(canvas, 0, 0);\n      return tCanvas;\n    }\n    function get2dContext(canvas) {\n      return canvas.getContext('2d');\n    }\n    function resize(canvas, width, height) {\n      canvas.width = width;\n      canvas.height = height;\n      return canvas;\n    }\n\n    function getWidth(image) {\n      return image.naturalWidth || image.width;\n    }\n    function getHeight(image) {\n      return image.naturalHeight || image.height;\n    }\n\n    var promise = function () {\n      var Promise = function (fn) {\n        if (typeof this !== 'object') {\n          throw new TypeError('Promises must be constructed via new');\n        }\n        if (typeof fn !== 'function') {\n          throw new TypeError('not a function');\n        }\n        this._state = null;\n        this._value = null;\n        this._deferreds = [];\n        doResolve(fn, bind(resolve, this), bind(reject, this));\n      };\n      var asap = Promise.immediateFn || typeof window.setImmediate === 'function' && window.setImmediate || function (fn) {\n        domGlobals.setTimeout(fn, 1);\n      };\n      function bind(fn, thisArg) {\n        return function () {\n          return fn.apply(thisArg, arguments);\n        };\n      }\n      var isArray = Array.isArray || function (value) {\n        return Object.prototype.toString.call(value) === '[object Array]';\n      };\n      function handle(deferred) {\n        var me = this;\n        if (this._state === null) {\n          this._deferreds.push(deferred);\n          return;\n        }\n        asap(function () {\n          var cb = me._state ? deferred.onFulfilled : deferred.onRejected;\n          if (cb === null) {\n            (me._state ? deferred.resolve : deferred.reject)(me._value);\n            return;\n          }\n          var ret;\n          try {\n            ret = cb(me._value);\n          } catch (e) {\n            deferred.reject(e);\n            return;\n          }\n          deferred.resolve(ret);\n        });\n      }\n      function resolve(newValue) {\n        try {\n          if (newValue === this) {\n            throw new TypeError('A promise cannot be resolved with itself.');\n          }\n          if (newValue && (typeof newValue === 'object' || typeof newValue === 'function')) {\n            var then = newValue.then;\n            if (typeof then === 'function') {\n              doResolve(bind(then, newValue), bind(resolve, this), bind(reject, this));\n              return;\n            }\n          }\n          this._state = true;\n          this._value = newValue;\n          finale.call(this);\n        } catch (e) {\n          reject.call(this, e);\n        }\n      }\n      function reject(newValue) {\n        this._state = false;\n        this._value = newValue;\n        finale.call(this);\n      }\n      function finale() {\n        for (var _i = 0, _a = this._deferreds; _i < _a.length; _i++) {\n          var deferred = _a[_i];\n          handle.call(this, deferred);\n        }\n        this._deferreds = [];\n      }\n      function Handler(onFulfilled, onRejected, resolve, reject) {\n        this.onFulfilled = typeof onFulfilled === 'function' ? onFulfilled : null;\n        this.onRejected = typeof onRejected === 'function' ? onRejected : null;\n        this.resolve = resolve;\n        this.reject = reject;\n      }\n      function doResolve(fn, onFulfilled, onRejected) {\n        var done = false;\n        try {\n          fn(function (value) {\n            if (done) {\n              return;\n            }\n            done = true;\n            onFulfilled(value);\n          }, function (reason) {\n            if (done) {\n              return;\n            }\n            done = true;\n            onRejected(reason);\n          });\n        } catch (ex) {\n          if (done) {\n            return;\n          }\n          done = true;\n          onRejected(ex);\n        }\n      }\n      Promise.prototype.catch = function (onRejected) {\n        return this.then(null, onRejected);\n      };\n      Promise.prototype.then = function (onFulfilled, onRejected) {\n        var me = this;\n        return new Promise(function (resolve, reject) {\n          handle.call(me, new Handler(onFulfilled, onRejected, resolve, reject));\n        });\n      };\n      Promise.all = function () {\n        var values = [];\n        for (var _i = 0; _i < arguments.length; _i++) {\n          values[_i] = arguments[_i];\n        }\n        var args = Array.prototype.slice.call(values.length === 1 && isArray(values[0]) ? values[0] : values);\n        return new Promise(function (resolve, reject) {\n          if (args.length === 0) {\n            return resolve([]);\n          }\n          var remaining = args.length;\n          function res(i, val) {\n            try {\n              if (val && (typeof val === 'object' || typeof val === 'function')) {\n                var then = val.then;\n                if (typeof then === 'function') {\n                  then.call(val, function (val) {\n                    res(i, val);\n                  }, reject);\n                  return;\n                }\n              }\n              args[i] = val;\n              if (--remaining === 0) {\n                resolve(args);\n              }\n            } catch (ex) {\n              reject(ex);\n            }\n          }\n          for (var i = 0; i < args.length; i++) {\n            res(i, args[i]);\n          }\n        });\n      };\n      Promise.resolve = function (value) {\n        if (value && typeof value === 'object' && value.constructor === Promise) {\n          return value;\n        }\n        return new Promise(function (resolve) {\n          resolve(value);\n        });\n      };\n      Promise.reject = function (reason) {\n        return new Promise(function (resolve, reject) {\n          reject(reason);\n        });\n      };\n      Promise.race = function (values) {\n        return new Promise(function (resolve, reject) {\n          for (var _i = 0, values_1 = values; _i < values_1.length; _i++) {\n            var value = values_1[_i];\n            value.then(resolve, reject);\n          }\n        });\n      };\n      return Promise;\n    };\n    var Promise = window.Promise ? window.Promise : promise();\n\n    function imageToBlob(image) {\n      var src = image.src;\n      if (src.indexOf('data:') === 0) {\n        return dataUriToBlob(src);\n      }\n      return anyUriToBlob(src);\n    }\n    function blobToImage(blob) {\n      return new Promise(function (resolve, reject) {\n        var blobUrl = domGlobals.URL.createObjectURL(blob);\n        var image = new domGlobals.Image();\n        var removeListeners = function () {\n          image.removeEventListener('load', loaded);\n          image.removeEventListener('error', error);\n        };\n        function loaded() {\n          removeListeners();\n          resolve(image);\n        }\n        function error() {\n          removeListeners();\n          reject('Unable to load data of type ' + blob.type + ': ' + blobUrl);\n        }\n        image.addEventListener('load', loaded);\n        image.addEventListener('error', error);\n        image.src = blobUrl;\n        if (image.complete) {\n          loaded();\n        }\n      });\n    }\n    function anyUriToBlob(url) {\n      return new Promise(function (resolve, reject) {\n        var xhr = new domGlobals.XMLHttpRequest();\n        xhr.open('GET', url, true);\n        xhr.responseType = 'blob';\n        xhr.onload = function () {\n          if (this.status === 200) {\n            resolve(this.response);\n          }\n        };\n        xhr.onerror = function () {\n          var _this = this;\n          var corsError = function () {\n            var obj = new Error('No access to download image');\n            obj.code = 18;\n            obj.name = 'SecurityError';\n            return obj;\n          };\n          var genericError = function () {\n            return new Error('Error ' + _this.status + ' downloading image');\n          };\n          reject(this.status === 0 ? corsError() : genericError());\n        };\n        xhr.send();\n      });\n    }\n    function dataUriToBlobSync(uri) {\n      var data = uri.split(',');\n      var matches = /data:([^;]+)/.exec(data[0]);\n      if (!matches) {\n        return Option.none();\n      }\n      var mimetype = matches[1];\n      var base64 = data[1];\n      var sliceSize = 1024;\n      var byteCharacters = domGlobals.atob(base64);\n      var bytesLength = byteCharacters.length;\n      var slicesCount = Math.ceil(bytesLength / sliceSize);\n      var byteArrays = new Array(slicesCount);\n      for (var sliceIndex = 0; sliceIndex < slicesCount; ++sliceIndex) {\n        var begin = sliceIndex * sliceSize;\n        var end = Math.min(begin + sliceSize, bytesLength);\n        var bytes = new Array(end - begin);\n        for (var offset = begin, i = 0; offset < end; ++i, ++offset) {\n          bytes[i] = byteCharacters[offset].charCodeAt(0);\n        }\n        byteArrays[sliceIndex] = new Uint8Array(bytes);\n      }\n      return Option.some(new domGlobals.Blob(byteArrays, { type: mimetype }));\n    }\n    function dataUriToBlob(uri) {\n      return new Promise(function (resolve, reject) {\n        dataUriToBlobSync(uri).fold(function () {\n          reject('uri is not base64: ' + uri);\n        }, resolve);\n      });\n    }\n    function canvasToBlob(canvas, type, quality) {\n      type = type || 'image/png';\n      if (domGlobals.HTMLCanvasElement.prototype.toBlob) {\n        return new Promise(function (resolve, reject) {\n          canvas.toBlob(function (blob) {\n            if (blob) {\n              resolve(blob);\n            } else {\n              reject();\n            }\n          }, type, quality);\n        });\n      } else {\n        return dataUriToBlob(canvas.toDataURL(type, quality));\n      }\n    }\n    function canvasToDataURL(canvas, type, quality) {\n      type = type || 'image/png';\n      return canvas.toDataURL(type, quality);\n    }\n    function blobToCanvas(blob) {\n      return blobToImage(blob).then(function (image) {\n        revokeImageUrl(image);\n        var canvas = create(getWidth(image), getHeight(image));\n        var context = get2dContext(canvas);\n        context.drawImage(image, 0, 0);\n        return canvas;\n      });\n    }\n    function blobToDataUri(blob) {\n      return new Promise(function (resolve) {\n        var reader = new domGlobals.FileReader();\n        reader.onloadend = function () {\n          resolve(reader.result);\n        };\n        reader.readAsDataURL(blob);\n      });\n    }\n    function revokeImageUrl(image) {\n      domGlobals.URL.revokeObjectURL(image.src);\n    }\n\n    var blobToImage$1 = function (blob) {\n      return blobToImage(blob);\n    };\n    var imageToBlob$1 = function (image) {\n      return imageToBlob(image);\n    };\n\n    function create$1(getCanvas, blob, uri) {\n      var initialType = blob.type;\n      var getType = constant(initialType);\n      function toBlob() {\n        return Promise.resolve(blob);\n      }\n      function toDataURL() {\n        return uri;\n      }\n      function toBase64() {\n        return uri.split(',')[1];\n      }\n      function toAdjustedBlob(type, quality) {\n        return getCanvas.then(function (canvas) {\n          return canvasToBlob(canvas, type, quality);\n        });\n      }\n      function toAdjustedDataURL(type, quality) {\n        return getCanvas.then(function (canvas) {\n          return canvasToDataURL(canvas, type, quality);\n        });\n      }\n      function toAdjustedBase64(type, quality) {\n        return toAdjustedDataURL(type, quality).then(function (dataurl) {\n          return dataurl.split(',')[1];\n        });\n      }\n      function toCanvas() {\n        return getCanvas.then(clone);\n      }\n      return {\n        getType: getType,\n        toBlob: toBlob,\n        toDataURL: toDataURL,\n        toBase64: toBase64,\n        toAdjustedBlob: toAdjustedBlob,\n        toAdjustedDataURL: toAdjustedDataURL,\n        toAdjustedBase64: toAdjustedBase64,\n        toCanvas: toCanvas\n      };\n    }\n    function fromBlob(blob) {\n      return blobToDataUri(blob).then(function (uri) {\n        return create$1(blobToCanvas(blob), blob, uri);\n      });\n    }\n    function fromCanvas(canvas, type) {\n      return canvasToBlob(canvas, type).then(function (blob) {\n        return create$1(Promise.resolve(canvas), blob, canvas.toDataURL());\n      });\n    }\n\n    function rotate(ir, angle) {\n      return ir.toCanvas().then(function (canvas) {\n        return applyRotate(canvas, ir.getType(), angle);\n      });\n    }\n    function applyRotate(image, type, angle) {\n      var canvas = create(image.width, image.height);\n      var context = get2dContext(canvas);\n      var translateX = 0;\n      var translateY = 0;\n      angle = angle < 0 ? 360 + angle : angle;\n      if (angle === 90 || angle === 270) {\n        resize(canvas, canvas.height, canvas.width);\n      }\n      if (angle === 90 || angle === 180) {\n        translateX = canvas.width;\n      }\n      if (angle === 270 || angle === 180) {\n        translateY = canvas.height;\n      }\n      context.translate(translateX, translateY);\n      context.rotate(angle * Math.PI / 180);\n      context.drawImage(image, 0, 0);\n      return fromCanvas(canvas, type);\n    }\n    function flip(ir, axis) {\n      return ir.toCanvas().then(function (canvas) {\n        return applyFlip(canvas, ir.getType(), axis);\n      });\n    }\n    function applyFlip(image, type, axis) {\n      var canvas = create(image.width, image.height);\n      var context = get2dContext(canvas);\n      if (axis === 'v') {\n        context.scale(1, -1);\n        context.drawImage(image, 0, -canvas.height);\n      } else {\n        context.scale(-1, 1);\n        context.drawImage(image, -canvas.width, 0);\n      }\n      return fromCanvas(canvas, type);\n    }\n\n    var flip$1 = function (ir, axis) {\n      return flip(ir, axis);\n    };\n    var rotate$1 = function (ir, angle) {\n      return rotate(ir, angle);\n    };\n\n    var blobToImageResult = function (blob) {\n      return fromBlob(blob);\n    };\n\n    var global$2 = tinymce.util.Tools.resolve('tinymce.util.Delay');\n\n    var global$3 = tinymce.util.Tools.resolve('tinymce.util.Promise');\n\n    var global$4 = tinymce.util.Tools.resolve('tinymce.util.URI');\n\n    var getToolbarItems = function (editor) {\n      return editor.getParam('imagetools_toolbar', 'rotateleft rotateright flipv fliph editimage imageoptions');\n    };\n    var getProxyUrl = function (editor) {\n      return editor.getParam('imagetools_proxy');\n    };\n    var getCorsHosts = function (editor) {\n      return editor.getParam('imagetools_cors_hosts', [], 'string[]');\n    };\n    var getCredentialsHosts = function (editor) {\n      return editor.getParam('imagetools_credentials_hosts', [], 'string[]');\n    };\n    var getFetchImage = function (editor) {\n      return Option.from(editor.getParam('imagetools_fetch_image', null, 'function'));\n    };\n    var getApiKey = function (editor) {\n      return editor.getParam('api_key', editor.getParam('imagetools_api_key', '', 'string'), 'string');\n    };\n    var getUploadTimeout = function (editor) {\n      return editor.getParam('images_upload_timeout', 30000, 'number');\n    };\n    var shouldReuseFilename = function (editor) {\n      return editor.getParam('images_reuse_filename', false, 'boolean');\n    };\n\n    function getImageSize(img) {\n      var width, height;\n      function isPxValue(value) {\n        return /^[0-9\\.]+px$/.test(value);\n      }\n      width = img.style.width;\n      height = img.style.height;\n      if (width || height) {\n        if (isPxValue(width) && isPxValue(height)) {\n          return {\n            w: parseInt(width, 10),\n            h: parseInt(height, 10)\n          };\n        }\n        return null;\n      }\n      width = img.width;\n      height = img.height;\n      if (width && height) {\n        return {\n          w: parseInt(width, 10),\n          h: parseInt(height, 10)\n        };\n      }\n      return null;\n    }\n    function setImageSize(img, size) {\n      var width, height;\n      if (size) {\n        width = img.style.width;\n        height = img.style.height;\n        if (width || height) {\n          img.style.width = size.w + 'px';\n          img.style.height = size.h + 'px';\n          img.removeAttribute('data-mce-style');\n        }\n        width = img.width;\n        height = img.height;\n        if (width || height) {\n          img.setAttribute('width', size.w);\n          img.setAttribute('height', size.h);\n        }\n      }\n    }\n    function getNaturalImageSize(img) {\n      return {\n        w: img.naturalWidth,\n        h: img.naturalHeight\n      };\n    }\n    var ImageSize = {\n      getImageSize: getImageSize,\n      setImageSize: setImageSize,\n      getNaturalImageSize: getNaturalImageSize\n    };\n\n    var typeOf = function (x) {\n      if (x === null) {\n        return 'null';\n      }\n      var t = typeof x;\n      if (t === 'object' && (Array.prototype.isPrototypeOf(x) || x.constructor && x.constructor.name === 'Array')) {\n        return 'array';\n      }\n      if (t === 'object' && (String.prototype.isPrototypeOf(x) || x.constructor && x.constructor.name === 'String')) {\n        return 'string';\n      }\n      return t;\n    };\n    var isType = function (type) {\n      return function (value) {\n        return typeOf(value) === type;\n      };\n    };\n    var isFunction = isType('function');\n\n    var nativeSlice = Array.prototype.slice;\n    var find = function (xs, pred) {\n      for (var i = 0, len = xs.length; i < len; i++) {\n        var x = xs[i];\n        if (pred(x, i)) {\n          return Option.some(x);\n        }\n      }\n      return Option.none();\n    };\n    var from$1 = isFunction(Array.from) ? Array.from : function (x) {\n      return nativeSlice.call(x);\n    };\n\n    var isValue = function (obj) {\n      return obj !== null && obj !== undefined;\n    };\n    var traverse = function (json, path) {\n      var value;\n      value = path.reduce(function (result, key) {\n        return isValue(result) ? result[key] : undefined;\n      }, json);\n      return isValue(value) ? value : null;\n    };\n    var requestUrlAsBlob = function (url, headers, withCredentials) {\n      return new global$3(function (resolve) {\n        var xhr;\n        xhr = new domGlobals.XMLHttpRequest();\n        xhr.onreadystatechange = function () {\n          if (xhr.readyState === 4) {\n            resolve({\n              status: xhr.status,\n              blob: this.response\n            });\n          }\n        };\n        xhr.open('GET', url, true);\n        xhr.withCredentials = withCredentials;\n        global$1.each(headers, function (value, key) {\n          xhr.setRequestHeader(key, value);\n        });\n        xhr.responseType = 'blob';\n        xhr.send();\n      });\n    };\n    var readBlob = function (blob) {\n      return new global$3(function (resolve) {\n        var fr = new domGlobals.FileReader();\n        fr.onload = function (e) {\n          var data = e.target;\n          resolve(data.result);\n        };\n        fr.readAsText(blob);\n      });\n    };\n    var parseJson = function (text) {\n      var json;\n      try {\n        json = JSON.parse(text);\n      } catch (ex) {\n      }\n      return json;\n    };\n    var Utils = {\n      traverse: traverse,\n      readBlob: readBlob,\n      requestUrlAsBlob: requestUrlAsBlob,\n      parseJson: parseJson\n    };\n\n    var friendlyHttpErrors = [\n      {\n        code: 404,\n        message: 'Could not find Image Proxy'\n      },\n      {\n        code: 403,\n        message: 'Rejected request'\n      },\n      {\n        code: 0,\n        message: 'Incorrect Image Proxy URL'\n      }\n    ];\n    var friendlyServiceErrors = [\n      {\n        type: 'key_missing',\n        message: 'The request did not include an api key.'\n      },\n      {\n        type: 'key_not_found',\n        message: 'The provided api key could not be found.'\n      },\n      {\n        type: 'domain_not_trusted',\n        message: 'The api key is not valid for the request origins.'\n      }\n    ];\n    var isServiceErrorCode = function (code) {\n      return code === 400 || code === 403 || code === 500;\n    };\n    var getHttpErrorMsg = function (status) {\n      var message = find(friendlyHttpErrors, function (error) {\n        return status === error.code;\n      }).fold(constant('Unknown ImageProxy error'), function (error) {\n        return error.message;\n      });\n      return 'ImageProxy HTTP error: ' + message;\n    };\n    var handleHttpError = function (status) {\n      var message = getHttpErrorMsg(status);\n      return global$3.reject(message);\n    };\n    var getServiceErrorMsg = function (type) {\n      return find(friendlyServiceErrors, function (error) {\n        return error.type === type;\n      }).fold(constant('Unknown service error'), function (error) {\n        return error.message;\n      });\n    };\n    var getServiceError = function (text) {\n      var serviceError = Utils.parseJson(text);\n      var errorType = Utils.traverse(serviceError, [\n        'error',\n        'type'\n      ]);\n      var errorMsg = errorType ? getServiceErrorMsg(errorType) : 'Invalid JSON in service error message';\n      return 'ImageProxy Service error: ' + errorMsg;\n    };\n    var handleServiceError = function (status, blob) {\n      return Utils.readBlob(blob).then(function (text) {\n        var serviceError = getServiceError(text);\n        return global$3.reject(serviceError);\n      });\n    };\n    var handleServiceErrorResponse = function (status, blob) {\n      return isServiceErrorCode(status) ? handleServiceError(status, blob) : handleHttpError(status);\n    };\n    var Errors = {\n      handleServiceErrorResponse: handleServiceErrorResponse,\n      handleHttpError: handleHttpError,\n      getHttpErrorMsg: getHttpErrorMsg,\n      getServiceErrorMsg: getServiceErrorMsg\n    };\n\n    var appendApiKey = function (url, apiKey) {\n      var separator = url.indexOf('?') === -1 ? '?' : '&';\n      if (/[?&]apiKey=/.test(url) || !apiKey) {\n        return url;\n      } else {\n        return url + separator + 'apiKey=' + encodeURIComponent(apiKey);\n      }\n    };\n    var requestServiceBlob = function (url, apiKey) {\n      var headers = {\n        'Content-Type': 'application/json;charset=UTF-8',\n        'tiny-api-key': apiKey\n      };\n      return Utils.requestUrlAsBlob(appendApiKey(url, apiKey), headers, false).then(function (result) {\n        return result.status < 200 || result.status >= 300 ? Errors.handleServiceErrorResponse(result.status, result.blob) : global$3.resolve(result.blob);\n      });\n    };\n    function requestBlob(url, withCredentials) {\n      return Utils.requestUrlAsBlob(url, {}, withCredentials).then(function (result) {\n        return result.status < 200 || result.status >= 300 ? Errors.handleHttpError(result.status) : global$3.resolve(result.blob);\n      });\n    }\n    var getUrl = function (url, apiKey, withCredentials) {\n      return apiKey ? requestServiceBlob(url, apiKey) : requestBlob(url, withCredentials);\n    };\n\n    var compareDocumentPosition = function (a, b, match) {\n      return (a.compareDocumentPosition(b) & match) !== 0;\n    };\n    var documentPositionPreceding = function (a, b) {\n      return compareDocumentPosition(a, b, domGlobals.Node.DOCUMENT_POSITION_PRECEDING);\n    };\n    var documentPositionContainedBy = function (a, b) {\n      return compareDocumentPosition(a, b, domGlobals.Node.DOCUMENT_POSITION_CONTAINED_BY);\n    };\n    var Node = {\n      documentPositionPreceding: documentPositionPreceding,\n      documentPositionContainedBy: documentPositionContainedBy\n    };\n\n    var firstMatch = function (regexes, s) {\n      for (var i = 0; i < regexes.length; i++) {\n        var x = regexes[i];\n        if (x.test(s)) {\n          return x;\n        }\n      }\n      return undefined;\n    };\n    var find$1 = function (regexes, agent) {\n      var r = firstMatch(regexes, agent);\n      if (!r) {\n        return {\n          major: 0,\n          minor: 0\n        };\n      }\n      var group = function (i) {\n        return Number(agent.replace(r, '$' + i));\n      };\n      return nu(group(1), group(2));\n    };\n    var detect = function (versionRegexes, agent) {\n      var cleanedAgent = String(agent).toLowerCase();\n      if (versionRegexes.length === 0) {\n        return unknown();\n      }\n      return find$1(versionRegexes, cleanedAgent);\n    };\n    var unknown = function () {\n      return nu(0, 0);\n    };\n    var nu = function (major, minor) {\n      return {\n        major: major,\n        minor: minor\n      };\n    };\n    var Version = {\n      nu: nu,\n      detect: detect,\n      unknown: unknown\n    };\n\n    var edge = 'Edge';\n    var chrome = 'Chrome';\n    var ie = 'IE';\n    var opera = 'Opera';\n    var firefox = 'Firefox';\n    var safari = 'Safari';\n    var isBrowser = function (name, current) {\n      return function () {\n        return current === name;\n      };\n    };\n    var unknown$1 = function () {\n      return nu$1({\n        current: undefined,\n        version: Version.unknown()\n      });\n    };\n    var nu$1 = function (info) {\n      var current = info.current;\n      var version = info.version;\n      return {\n        current: current,\n        version: version,\n        isEdge: isBrowser(edge, current),\n        isChrome: isBrowser(chrome, current),\n        isIE: isBrowser(ie, current),\n        isOpera: isBrowser(opera, current),\n        isFirefox: isBrowser(firefox, current),\n        isSafari: isBrowser(safari, current)\n      };\n    };\n    var Browser = {\n      unknown: unknown$1,\n      nu: nu$1,\n      edge: constant(edge),\n      chrome: constant(chrome),\n      ie: constant(ie),\n      opera: constant(opera),\n      firefox: constant(firefox),\n      safari: constant(safari)\n    };\n\n    var windows = 'Windows';\n    var ios = 'iOS';\n    var android = 'Android';\n    var linux = 'Linux';\n    var osx = 'OSX';\n    var solaris = 'Solaris';\n    var freebsd = 'FreeBSD';\n    var isOS = function (name, current) {\n      return function () {\n        return current === name;\n      };\n    };\n    var unknown$2 = function () {\n      return nu$2({\n        current: undefined,\n        version: Version.unknown()\n      });\n    };\n    var nu$2 = function (info) {\n      var current = info.current;\n      var version = info.version;\n      return {\n        current: current,\n        version: version,\n        isWindows: isOS(windows, current),\n        isiOS: isOS(ios, current),\n        isAndroid: isOS(android, current),\n        isOSX: isOS(osx, current),\n        isLinux: isOS(linux, current),\n        isSolaris: isOS(solaris, current),\n        isFreeBSD: isOS(freebsd, current)\n      };\n    };\n    var OperatingSystem = {\n      unknown: unknown$2,\n      nu: nu$2,\n      windows: constant(windows),\n      ios: constant(ios),\n      android: constant(android),\n      linux: constant(linux),\n      osx: constant(osx),\n      solaris: constant(solaris),\n      freebsd: constant(freebsd)\n    };\n\n    var DeviceType = function (os, browser, userAgent, mediaMatch) {\n      var isiPad = os.isiOS() && /ipad/i.test(userAgent) === true;\n      var isiPhone = os.isiOS() && !isiPad;\n      var isMobile = os.isiOS() || os.isAndroid();\n      var isTouch = isMobile || mediaMatch('(pointer:coarse)');\n      var isTablet = isiPad || !isiPhone && isMobile && mediaMatch('(min-device-width:768px)');\n      var isPhone = isiPhone || isMobile && !isTablet;\n      var iOSwebview = browser.isSafari() && os.isiOS() && /safari/i.test(userAgent) === false;\n      var isDesktop = !isPhone && !isTablet && !iOSwebview;\n      return {\n        isiPad: constant(isiPad),\n        isiPhone: constant(isiPhone),\n        isTablet: constant(isTablet),\n        isPhone: constant(isPhone),\n        isTouch: constant(isTouch),\n        isAndroid: os.isAndroid,\n        isiOS: os.isiOS,\n        isWebView: constant(iOSwebview),\n        isDesktop: constant(isDesktop)\n      };\n    };\n\n    var detect$1 = function (candidates, userAgent) {\n      var agent = String(userAgent).toLowerCase();\n      return find(candidates, function (candidate) {\n        return candidate.search(agent);\n      });\n    };\n    var detectBrowser = function (browsers, userAgent) {\n      return detect$1(browsers, userAgent).map(function (browser) {\n        var version = Version.detect(browser.versionRegexes, userAgent);\n        return {\n          current: browser.name,\n          version: version\n        };\n      });\n    };\n    var detectOs = function (oses, userAgent) {\n      return detect$1(oses, userAgent).map(function (os) {\n        var version = Version.detect(os.versionRegexes, userAgent);\n        return {\n          current: os.name,\n          version: version\n        };\n      });\n    };\n    var UaString = {\n      detectBrowser: detectBrowser,\n      detectOs: detectOs\n    };\n\n    var contains = function (str, substr) {\n      return str.indexOf(substr) !== -1;\n    };\n\n    var normalVersionRegex = /.*?version\\/\\ ?([0-9]+)\\.([0-9]+).*/;\n    var checkContains = function (target) {\n      return function (uastring) {\n        return contains(uastring, target);\n      };\n    };\n    var browsers = [\n      {\n        name: 'Edge',\n        versionRegexes: [/.*?edge\\/ ?([0-9]+)\\.([0-9]+)$/],\n        search: function (uastring) {\n          return contains(uastring, 'edge/') && contains(uastring, 'chrome') && contains(uastring, 'safari') && contains(uastring, 'applewebkit');\n        }\n      },\n      {\n        name: 'Chrome',\n        versionRegexes: [\n          /.*?chrome\\/([0-9]+)\\.([0-9]+).*/,\n          normalVersionRegex\n        ],\n        search: function (uastring) {\n          return contains(uastring, 'chrome') && !contains(uastring, 'chromeframe');\n        }\n      },\n      {\n        name: 'IE',\n        versionRegexes: [\n          /.*?msie\\ ?([0-9]+)\\.([0-9]+).*/,\n          /.*?rv:([0-9]+)\\.([0-9]+).*/\n        ],\n        search: function (uastring) {\n          return contains(uastring, 'msie') || contains(uastring, 'trident');\n        }\n      },\n      {\n        name: 'Opera',\n        versionRegexes: [\n          normalVersionRegex,\n          /.*?opera\\/([0-9]+)\\.([0-9]+).*/\n        ],\n        search: checkContains('opera')\n      },\n      {\n        name: 'Firefox',\n        versionRegexes: [/.*?firefox\\/\\ ?([0-9]+)\\.([0-9]+).*/],\n        search: checkContains('firefox')\n      },\n      {\n        name: 'Safari',\n        versionRegexes: [\n          normalVersionRegex,\n          /.*?cpu os ([0-9]+)_([0-9]+).*/\n        ],\n        search: function (uastring) {\n          return (contains(uastring, 'safari') || contains(uastring, 'mobile/')) && contains(uastring, 'applewebkit');\n        }\n      }\n    ];\n    var oses = [\n      {\n        name: 'Windows',\n        search: checkContains('win'),\n        versionRegexes: [/.*?windows\\ nt\\ ?([0-9]+)\\.([0-9]+).*/]\n      },\n      {\n        name: 'iOS',\n        search: function (uastring) {\n          return contains(uastring, 'iphone') || contains(uastring, 'ipad');\n        },\n        versionRegexes: [\n          /.*?version\\/\\ ?([0-9]+)\\.([0-9]+).*/,\n          /.*cpu os ([0-9]+)_([0-9]+).*/,\n          /.*cpu iphone os ([0-9]+)_([0-9]+).*/\n        ]\n      },\n      {\n        name: 'Android',\n        search: checkContains('android'),\n        versionRegexes: [/.*?android\\ ?([0-9]+)\\.([0-9]+).*/]\n      },\n      {\n        name: 'OSX',\n        search: checkContains('os x'),\n        versionRegexes: [/.*?os\\ x\\ ?([0-9]+)_([0-9]+).*/]\n      },\n      {\n        name: 'Linux',\n        search: checkContains('linux'),\n        versionRegexes: []\n      },\n      {\n        name: 'Solaris',\n        search: checkContains('sunos'),\n        versionRegexes: []\n      },\n      {\n        name: 'FreeBSD',\n        search: checkContains('freebsd'),\n        versionRegexes: []\n      }\n    ];\n    var PlatformInfo = {\n      browsers: constant(browsers),\n      oses: constant(oses)\n    };\n\n    var detect$2 = function (userAgent, mediaMatch) {\n      var browsers = PlatformInfo.browsers();\n      var oses = PlatformInfo.oses();\n      var browser = UaString.detectBrowser(browsers, userAgent).fold(Browser.unknown, Browser.nu);\n      var os = UaString.detectOs(oses, userAgent).fold(OperatingSystem.unknown, OperatingSystem.nu);\n      var deviceType = DeviceType(os, browser, userAgent, mediaMatch);\n      return {\n        browser: browser,\n        os: os,\n        deviceType: deviceType\n      };\n    };\n    var PlatformDetection = { detect: detect$2 };\n\n    var mediaMatch = function (query) {\n      return domGlobals.window.matchMedia(query).matches;\n    };\n    var platform = Cell(PlatformDetection.detect(domGlobals.navigator.userAgent, mediaMatch));\n    var detect$3 = function () {\n      return platform.get();\n    };\n\n    var fromHtml = function (html, scope) {\n      var doc = scope || domGlobals.document;\n      var div = doc.createElement('div');\n      div.innerHTML = html;\n      if (!div.hasChildNodes() || div.childNodes.length > 1) {\n        domGlobals.console.error('HTML does not have a single root node', html);\n        throw new Error('HTML must have a single root node');\n      }\n      return fromDom(div.childNodes[0]);\n    };\n    var fromTag = function (tag, scope) {\n      var doc = scope || domGlobals.document;\n      var node = doc.createElement(tag);\n      return fromDom(node);\n    };\n    var fromText = function (text, scope) {\n      var doc = scope || domGlobals.document;\n      var node = doc.createTextNode(text);\n      return fromDom(node);\n    };\n    var fromDom = function (node) {\n      if (node === null || node === undefined) {\n        throw new Error('Node cannot be null or undefined');\n      }\n      return { dom: constant(node) };\n    };\n    var fromPoint = function (docElm, x, y) {\n      var doc = docElm.dom();\n      return Option.from(doc.elementFromPoint(x, y)).map(fromDom);\n    };\n    var Element = {\n      fromHtml: fromHtml,\n      fromTag: fromTag,\n      fromText: fromText,\n      fromDom: fromDom,\n      fromPoint: fromPoint\n    };\n\n    var ATTRIBUTE = domGlobals.Node.ATTRIBUTE_NODE;\n    var CDATA_SECTION = domGlobals.Node.CDATA_SECTION_NODE;\n    var COMMENT = domGlobals.Node.COMMENT_NODE;\n    var DOCUMENT = domGlobals.Node.DOCUMENT_NODE;\n    var DOCUMENT_TYPE = domGlobals.Node.DOCUMENT_TYPE_NODE;\n    var DOCUMENT_FRAGMENT = domGlobals.Node.DOCUMENT_FRAGMENT_NODE;\n    var ELEMENT = domGlobals.Node.ELEMENT_NODE;\n    var TEXT = domGlobals.Node.TEXT_NODE;\n    var PROCESSING_INSTRUCTION = domGlobals.Node.PROCESSING_INSTRUCTION_NODE;\n    var ENTITY_REFERENCE = domGlobals.Node.ENTITY_REFERENCE_NODE;\n    var ENTITY = domGlobals.Node.ENTITY_NODE;\n    var NOTATION = domGlobals.Node.NOTATION_NODE;\n\n    var ELEMENT$1 = ELEMENT;\n    var is = function (element, selector) {\n      var dom = element.dom();\n      if (dom.nodeType !== ELEMENT$1) {\n        return false;\n      } else {\n        var elem = dom;\n        if (elem.matches !== undefined) {\n          return elem.matches(selector);\n        } else if (elem.msMatchesSelector !== undefined) {\n          return elem.msMatchesSelector(selector);\n        } else if (elem.webkitMatchesSelector !== undefined) {\n          return elem.webkitMatchesSelector(selector);\n        } else if (elem.mozMatchesSelector !== undefined) {\n          return elem.mozMatchesSelector(selector);\n        } else {\n          throw new Error('Browser lacks native selectors');\n        }\n      }\n    };\n\n    var regularContains = function (e1, e2) {\n      var d1 = e1.dom();\n      var d2 = e2.dom();\n      return d1 === d2 ? false : d1.contains(d2);\n    };\n    var ieContains = function (e1, e2) {\n      return Node.documentPositionContainedBy(e1.dom(), e2.dom());\n    };\n    var browser = detect$3().browser;\n    var contains$1 = browser.isIE() ? ieContains : regularContains;\n\n    var Global = typeof domGlobals.window !== 'undefined' ? domGlobals.window : Function('return this;')();\n\n    var child = function (scope, predicate) {\n      var pred = function (node) {\n        return predicate(Element.fromDom(node));\n      };\n      var result = find(scope.dom().childNodes, pred);\n      return result.map(Element.fromDom);\n    };\n\n    var child$1 = function (scope, selector) {\n      return child(scope, function (e) {\n        return is(e, selector);\n      });\n    };\n\n    var count = 0;\n    var getFigureImg = function (elem) {\n      return child$1(Element.fromDom(elem), 'img');\n    };\n    var isFigure = function (editor, elem) {\n      return editor.dom.is(elem, 'figure');\n    };\n    var getEditableImage = function (editor, elem) {\n      var isImage = function (imgNode) {\n        return editor.dom.is(imgNode, 'img:not([data-mce-object],[data-mce-placeholder])');\n      };\n      var isEditable = function (imgNode) {\n        return isImage(imgNode) && (isLocalImage(editor, imgNode) || isCorsImage(editor, imgNode) || editor.settings.imagetools_proxy);\n      };\n      if (isFigure(editor, elem)) {\n        var imgOpt = getFigureImg(elem);\n        return imgOpt.map(function (img) {\n          return isEditable(img.dom()) ? Option.some(img.dom()) : Option.none();\n        });\n      }\n      return isEditable(elem) ? Option.some(elem) : Option.none();\n    };\n    var displayError = function (editor, error) {\n      editor.notificationManager.open({\n        text: error,\n        type: 'error'\n      });\n    };\n    var getSelectedImage = function (editor) {\n      var elem = editor.selection.getNode();\n      if (isFigure(editor, elem)) {\n        return getFigureImg(elem);\n      } else {\n        return Option.some(Element.fromDom(elem));\n      }\n    };\n    var extractFilename = function (editor, url) {\n      var m = url.match(/\\/([^\\/\\?]+)?\\.(?:jpeg|jpg|png|gif)(?:\\?|$)/i);\n      if (m) {\n        return editor.dom.encode(m[1]);\n      }\n      return null;\n    };\n    var createId = function () {\n      return 'imagetools' + count++;\n    };\n    var isLocalImage = function (editor, img) {\n      var url = img.src;\n      return url.indexOf('data:') === 0 || url.indexOf('blob:') === 0 || new global$4(url).host === editor.documentBaseURI.host;\n    };\n    var isCorsImage = function (editor, img) {\n      return global$1.inArray(getCorsHosts(editor), new global$4(img.src).host) !== -1;\n    };\n    var isCorsWithCredentialsImage = function (editor, img) {\n      return global$1.inArray(getCredentialsHosts(editor), new global$4(img.src).host) !== -1;\n    };\n    var defaultFetchImage = function (editor, img) {\n      var src = img.src, apiKey;\n      if (isCorsImage(editor, img)) {\n        return getUrl(img.src, null, isCorsWithCredentialsImage(editor, img));\n      }\n      if (!isLocalImage(editor, img)) {\n        src = getProxyUrl(editor);\n        src += (src.indexOf('?') === -1 ? '?' : '&') + 'url=' + encodeURIComponent(img.src);\n        apiKey = getApiKey(editor);\n        return getUrl(src, apiKey, false);\n      }\n      return imageToBlob$1(img);\n    };\n    var imageToBlob$2 = function (editor, img) {\n      return getFetchImage(editor).fold(function () {\n        return defaultFetchImage(editor, img);\n      }, function (customFetchImage) {\n        return customFetchImage(img);\n      });\n    };\n    var findBlob = function (editor, img) {\n      var blobInfo;\n      blobInfo = editor.editorUpload.blobCache.getByUri(img.src);\n      if (blobInfo) {\n        return global$3.resolve(blobInfo.blob());\n      }\n      return imageToBlob$2(editor, img);\n    };\n    var startTimedUpload = function (editor, imageUploadTimerState) {\n      var imageUploadTimer = global$2.setEditorTimeout(editor, function () {\n        editor.editorUpload.uploadImagesAuto();\n      }, getUploadTimeout(editor));\n      imageUploadTimerState.set(imageUploadTimer);\n    };\n    var cancelTimedUpload = function (imageUploadTimerState) {\n      global$2.clearTimeout(imageUploadTimerState.get());\n    };\n    var updateSelectedImage = function (editor, ir, uploadImmediately, imageUploadTimerState, selectedImage, size) {\n      return ir.toBlob().then(function (blob) {\n        var uri, name, blobCache, blobInfo;\n        blobCache = editor.editorUpload.blobCache;\n        uri = selectedImage.src;\n        if (shouldReuseFilename(editor)) {\n          blobInfo = blobCache.getByUri(uri);\n          if (blobInfo) {\n            uri = blobInfo.uri();\n            name = blobInfo.name();\n          } else {\n            name = extractFilename(editor, uri);\n          }\n        }\n        blobInfo = blobCache.create({\n          id: createId(),\n          blob: blob,\n          base64: ir.toBase64(),\n          uri: uri,\n          name: name\n        });\n        blobCache.add(blobInfo);\n        editor.undoManager.transact(function () {\n          function imageLoadedHandler() {\n            editor.$(selectedImage).off('load', imageLoadedHandler);\n            editor.nodeChanged();\n            if (uploadImmediately) {\n              editor.editorUpload.uploadImagesAuto();\n            } else {\n              cancelTimedUpload(imageUploadTimerState);\n              startTimedUpload(editor, imageUploadTimerState);\n            }\n          }\n          editor.$(selectedImage).on('load', imageLoadedHandler);\n          if (size) {\n            editor.$(selectedImage).attr({\n              width: size.w,\n              height: size.h\n            });\n          }\n          editor.$(selectedImage).attr({ src: blobInfo.blobUri() }).removeAttr('data-mce-src');\n        });\n        return blobInfo;\n      });\n    };\n    var selectedImageOperation = function (editor, imageUploadTimerState, fn, size) {\n      return function () {\n        var imgOpt = getSelectedImage(editor);\n        return imgOpt.fold(function () {\n          displayError(editor, 'Could not find selected image');\n        }, function (img) {\n          return editor._scanForImages().then(function () {\n            return findBlob(editor, img.dom());\n          }).then(blobToImageResult).then(fn).then(function (imageResult) {\n            return updateSelectedImage(editor, imageResult, false, imageUploadTimerState, img.dom(), size);\n          }, function (error) {\n            displayError(editor, error);\n          });\n        });\n      };\n    };\n    var rotate$2 = function (editor, imageUploadTimerState, angle) {\n      return function () {\n        var imgOpt = getSelectedImage(editor);\n        var flippedSize = imgOpt.fold(function () {\n          return null;\n        }, function (img) {\n          var size = ImageSize.getImageSize(img.dom());\n          return size ? {\n            w: size.h,\n            h: size.w\n          } : null;\n        });\n        return selectedImageOperation(editor, imageUploadTimerState, function (imageResult) {\n          return rotate$1(imageResult, angle);\n        }, flippedSize)();\n      };\n    };\n    var flip$2 = function (editor, imageUploadTimerState, axis) {\n      return function () {\n        return selectedImageOperation(editor, imageUploadTimerState, function (imageResult) {\n          return flip$1(imageResult, axis);\n        })();\n      };\n    };\n    var handleDialogBlob = function (editor, imageUploadTimerState, img, originalSize, blob) {\n      return new global$3(function (resolve) {\n        blobToImage$1(blob).then(function (newImage) {\n          var newSize = ImageSize.getNaturalImageSize(newImage);\n          if (originalSize.w !== newSize.w || originalSize.h !== newSize.h) {\n            if (ImageSize.getImageSize(img)) {\n              ImageSize.setImageSize(img, newSize);\n            }\n          }\n          domGlobals.URL.revokeObjectURL(newImage.src);\n          return blob;\n        }).then(blobToImageResult).then(function (imageResult) {\n          return updateSelectedImage(editor, imageResult, true, imageUploadTimerState, img);\n        }, function () {\n        });\n      });\n    };\n    var Actions = {\n      rotate: rotate$2,\n      flip: flip$2,\n      getEditableImage: getEditableImage,\n      cancelTimedUpload: cancelTimedUpload,\n      findBlob: findBlob,\n      getSelectedImage: getSelectedImage,\n      handleDialogBlob: handleDialogBlob\n    };\n\n    var saveState = constant('save-state');\n    var disable = constant('disable');\n    var enable = constant('enable');\n\n    var createState = function (blob) {\n      return {\n        blob: blob,\n        url: domGlobals.URL.createObjectURL(blob)\n      };\n    };\n    var makeOpen = function (editor, imageUploadTimerState) {\n      return function () {\n        var getLoadedSpec = function (currentState) {\n          return {\n            title: 'Edit Image',\n            size: 'large',\n            body: {\n              type: 'panel',\n              items: [{\n                  type: 'imagetools',\n                  name: 'imagetools',\n                  label: 'Edit Image',\n                  currentState: currentState\n                }]\n            },\n            buttons: [\n              {\n                type: 'cancel',\n                name: 'cancel',\n                text: 'Cancel'\n              },\n              {\n                type: 'submit',\n                name: 'save',\n                text: 'Save',\n                primary: true,\n                disabled: true\n              }\n            ],\n            onSubmit: function (api) {\n              var blob = api.getData().imagetools.blob;\n              originalImgOpt.each(function (originalImg) {\n                originalSizeOpt.each(function (originalSize) {\n                  Actions.handleDialogBlob(editor, imageUploadTimerState, originalImg.dom(), originalSize, blob);\n                });\n              });\n              api.close();\n            },\n            onCancel: function () {\n            },\n            onAction: function (api, details) {\n              switch (details.name) {\n              case saveState():\n                if (details.value) {\n                  api.enable('save');\n                } else {\n                  api.disable('save');\n                }\n                break;\n              case disable():\n                api.disable('save');\n                api.disable('cancel');\n                break;\n              case enable():\n                api.enable('cancel');\n                break;\n              }\n            }\n          };\n        };\n        var originalImgOpt = Actions.getSelectedImage(editor);\n        var originalSizeOpt = originalImgOpt.map(function (origImg) {\n          return ImageSize.getNaturalImageSize(origImg.dom());\n        });\n        var imgOpt = Actions.getSelectedImage(editor);\n        imgOpt.each(function (img) {\n          Actions.getEditableImage(editor, img.dom()).each(function (_) {\n            Actions.findBlob(editor, img.dom()).then(function (blob) {\n              var state = createState(blob);\n              editor.windowManager.open(getLoadedSpec(state));\n            });\n          });\n        });\n      };\n    };\n    var Dialog = { makeOpen: makeOpen };\n\n    var register = function (editor, imageUploadTimerState) {\n      global$1.each({\n        mceImageRotateLeft: Actions.rotate(editor, imageUploadTimerState, -90),\n        mceImageRotateRight: Actions.rotate(editor, imageUploadTimerState, 90),\n        mceImageFlipVertical: Actions.flip(editor, imageUploadTimerState, 'v'),\n        mceImageFlipHorizontal: Actions.flip(editor, imageUploadTimerState, 'h'),\n        mceEditImage: Dialog.makeOpen(editor, imageUploadTimerState)\n      }, function (fn, cmd) {\n        editor.addCommand(cmd, fn);\n      });\n    };\n    var Commands = { register: register };\n\n    var setup = function (editor, imageUploadTimerState, lastSelectedImageState) {\n      editor.on('NodeChange', function (e) {\n        var lastSelectedImage = lastSelectedImageState.get();\n        if (lastSelectedImage && lastSelectedImage.src !== e.element.src) {\n          Actions.cancelTimedUpload(imageUploadTimerState);\n          editor.editorUpload.uploadImagesAuto();\n          lastSelectedImageState.set(null);\n        }\n        Actions.getEditableImage(editor, e.element).each(lastSelectedImageState.set);\n      });\n    };\n    var UploadSelectedImage = { setup: setup };\n\n    var register$1 = function (editor) {\n      var cmd = function (command) {\n        return function () {\n          return editor.execCommand(command);\n        };\n      };\n      editor.ui.registry.addButton('rotateleft', {\n        tooltip: 'Rotate counterclockwise',\n        icon: 'rotate-left',\n        onAction: cmd('mceImageRotateLeft')\n      });\n      editor.ui.registry.addButton('rotateright', {\n        tooltip: 'Rotate clockwise',\n        icon: 'rotate-right',\n        onAction: cmd('mceImageRotateRight')\n      });\n      editor.ui.registry.addButton('flipv', {\n        tooltip: 'Flip vertically',\n        icon: 'flip-vertically',\n        onAction: cmd('mceImageFlipVertical')\n      });\n      editor.ui.registry.addButton('fliph', {\n        tooltip: 'Flip horizontally',\n        icon: 'flip-horizontally',\n        onAction: cmd('mceImageFlipHorizontal')\n      });\n      editor.ui.registry.addButton('editimage', {\n        tooltip: 'Edit image',\n        icon: 'edit-image',\n        onAction: cmd('mceEditImage'),\n        onSetup: function (buttonApi) {\n          var setDisabled = function () {\n            var elementOpt = Actions.getSelectedImage(editor);\n            elementOpt.each(function (element) {\n              var disabled = Actions.getEditableImage(editor, element.dom()).isNone();\n              buttonApi.setDisabled(disabled);\n            });\n          };\n          editor.on('NodeChange', setDisabled);\n          return function () {\n            editor.off('NodeChange', setDisabled);\n          };\n        }\n      });\n      editor.ui.registry.addButton('imageoptions', {\n        tooltip: 'Image options',\n        icon: 'image-options',\n        onAction: cmd('mceImage')\n      });\n      editor.ui.registry.addContextMenu('imagetools', {\n        update: function (element) {\n          return Actions.getEditableImage(editor, element).fold(function () {\n            return [];\n          }, function (_) {\n            return [{\n                text: 'Edit image',\n                icon: 'edit-image',\n                onAction: cmd('mceEditImage')\n              }];\n          });\n        }\n      });\n    };\n    var Buttons = { register: register$1 };\n\n    var register$2 = function (editor) {\n      editor.ui.registry.addContextToolbar('imagetools', {\n        items: getToolbarItems(editor),\n        predicate: function (elem) {\n          return Actions.getEditableImage(editor, elem).isSome();\n        },\n        position: 'node',\n        scope: 'node'\n      });\n    };\n    var ContextToolbar = { register: register$2 };\n\n    function Plugin () {\n      global.add('imagetools', function (editor) {\n        var imageUploadTimerState = Cell(0);\n        var lastSelectedImageState = Cell(null);\n        Commands.register(editor, imageUploadTimerState);\n        Buttons.register(editor);\n        ContextToolbar.register(editor);\n        UploadSelectedImage.setup(editor, imageUploadTimerState, lastSelectedImageState);\n      });\n    }\n\n    Plugin();\n\n}(window));\n"]}