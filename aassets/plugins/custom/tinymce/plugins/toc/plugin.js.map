{"version":3,"sources":["toc/plugin.js"],"names":["global","tinymce","util","Tools","resolve","global$1","global$2","global$3","Settings","editor","getParam","tagName","test","depth","parseInt","tocId","prefix","counter","guid","Date","getTime","toString","Guid","readHeaders","tocClass","headerTag","selector","i","push","join","generateSelector","headers","$","length","filter","el","dom","hasClass","parentNode","map","h","id","level","nodeName","replace","title","text","element","generateTocContentHtml","ii","nextLevel","tag","closeTag","html","prevLevel","minLevel","getMinLevel","translate","DOM","encode","updateToc","$tocElm","undoManager","transact","Toc","hasHeaders","insertToc","nodes","getParents","isEmptyOrOffscren","insertContent","generateTocHtml","Commands","register","addCommand","FilterContent","setup","on","e","node","removeAttr","find","attr","children","toggleState","api","toggleDisabledState","setDisabled","readonly","isToc","elm","is","getBody","contains","Buttons","ui","registry","addButton","icon","tooltip","onAction","execCommand","onSetup","addMenuItem","addContextToolbar","items","predicate","scope","position","add"],"mappings":"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","file":"plugin.js","sourcesContent":["/**\n * Copyright (c) Tiny Technologies, Inc. All rights reserved.\n * Licensed under the LGPL or a commercial license.\n * For LGPL see License.txt in the project root for license information.\n * For commercial licenses see https://www.tiny.cloud/\n *\n * Version: 5.1.0 (2019-10-17)\n */\n(function () {\n    'use strict';\n\n    var global = tinymce.util.Tools.resolve('tinymce.PluginManager');\n\n    var global$1 = tinymce.util.Tools.resolve('tinymce.dom.DOMUtils');\n\n    var global$2 = tinymce.util.Tools.resolve('tinymce.util.I18n');\n\n    var global$3 = tinymce.util.Tools.resolve('tinymce.util.Tools');\n\n    var getTocClass = function (editor) {\n      return editor.getParam('toc_class', 'mce-toc');\n    };\n    var getTocHeader = function (editor) {\n      var tagName = editor.getParam('toc_header', 'h2');\n      return /^h[1-6]$/.test(tagName) ? tagName : 'h2';\n    };\n    var getTocDepth = function (editor) {\n      var depth = parseInt(editor.getParam('toc_depth', '3'), 10);\n      return depth >= 1 && depth <= 9 ? depth : 3;\n    };\n    var Settings = {\n      getTocClass: getTocClass,\n      getTocHeader: getTocHeader,\n      getTocDepth: getTocDepth\n    };\n\n    var create = function (prefix) {\n      var counter = 0;\n      return function () {\n        var guid = new Date().getTime().toString(32);\n        return prefix + guid + (counter++).toString(32);\n      };\n    };\n    var Guid = { create: create };\n\n    var tocId = Guid.create('mcetoc_');\n    var generateSelector = function generateSelector(depth) {\n      var i;\n      var selector = [];\n      for (i = 1; i <= depth; i++) {\n        selector.push('h' + i);\n      }\n      return selector.join(',');\n    };\n    var hasHeaders = function (editor) {\n      return readHeaders(editor).length > 0;\n    };\n    var readHeaders = function (editor) {\n      var tocClass = Settings.getTocClass(editor);\n      var headerTag = Settings.getTocHeader(editor);\n      var selector = generateSelector(Settings.getTocDepth(editor));\n      var headers = editor.$(selector);\n      if (headers.length && /^h[1-9]$/i.test(headerTag)) {\n        headers = headers.filter(function (i, el) {\n          return !editor.dom.hasClass(el.parentNode, tocClass);\n        });\n      }\n      return global$3.map(headers, function (h) {\n        return {\n          id: h.id ? h.id : tocId(),\n          level: parseInt(h.nodeName.replace(/^H/i, ''), 10),\n          title: editor.$.text(h),\n          element: h\n        };\n      });\n    };\n    var getMinLevel = function (headers) {\n      var i, minLevel = 9;\n      for (i = 0; i < headers.length; i++) {\n        if (headers[i].level < minLevel) {\n          minLevel = headers[i].level;\n        }\n        if (minLevel === 1) {\n          return minLevel;\n        }\n      }\n      return minLevel;\n    };\n    var generateTitle = function (tag, title) {\n      var openTag = '<' + tag + ' contenteditable=\"true\">';\n      var closeTag = '</' + tag + '>';\n      return openTag + global$1.DOM.encode(title) + closeTag;\n    };\n    var generateTocHtml = function (editor) {\n      var html = generateTocContentHtml(editor);\n      return '<div class=\"' + editor.dom.encode(Settings.getTocClass(editor)) + '\" contenteditable=\"false\">' + html + '</div>';\n    };\n    var generateTocContentHtml = function (editor) {\n      var html = '';\n      var headers = readHeaders(editor);\n      var prevLevel = getMinLevel(headers) - 1;\n      var i, ii, h, nextLevel;\n      if (!headers.length) {\n        return '';\n      }\n      html += generateTitle(Settings.getTocHeader(editor), global$2.translate('Table of Contents'));\n      for (i = 0; i < headers.length; i++) {\n        h = headers[i];\n        h.element.id = h.id;\n        nextLevel = headers[i + 1] && headers[i + 1].level;\n        if (prevLevel === h.level) {\n          html += '<li>';\n        } else {\n          for (ii = prevLevel; ii < h.level; ii++) {\n            html += '<ul><li>';\n          }\n        }\n        html += '<a href=\"#' + h.id + '\">' + h.title + '</a>';\n        if (nextLevel === h.level || !nextLevel) {\n          html += '</li>';\n          if (!nextLevel) {\n            html += '</ul>';\n          }\n        } else {\n          for (ii = h.level; ii > nextLevel; ii--) {\n            html += '</li></ul><li>';\n          }\n        }\n        prevLevel = h.level;\n      }\n      return html;\n    };\n    var isEmptyOrOffscren = function (editor, nodes) {\n      return !nodes.length || editor.dom.getParents(nodes[0], '.mce-offscreen-selection').length > 0;\n    };\n    var insertToc = function (editor) {\n      var tocClass = Settings.getTocClass(editor);\n      var $tocElm = editor.$('.' + tocClass);\n      if (isEmptyOrOffscren(editor, $tocElm)) {\n        editor.insertContent(generateTocHtml(editor));\n      } else {\n        updateToc(editor);\n      }\n    };\n    var updateToc = function (editor) {\n      var tocClass = Settings.getTocClass(editor);\n      var $tocElm = editor.$('.' + tocClass);\n      if ($tocElm.length) {\n        editor.undoManager.transact(function () {\n          $tocElm.html(generateTocContentHtml(editor));\n        });\n      }\n    };\n    var Toc = {\n      hasHeaders: hasHeaders,\n      insertToc: insertToc,\n      updateToc: updateToc\n    };\n\n    var register = function (editor) {\n      editor.addCommand('mceInsertToc', function () {\n        Toc.insertToc(editor);\n      });\n      editor.addCommand('mceUpdateToc', function () {\n        Toc.updateToc(editor);\n      });\n    };\n    var Commands = { register: register };\n\n    var setup = function (editor) {\n      var $ = editor.$, tocClass = Settings.getTocClass(editor);\n      editor.on('PreProcess', function (e) {\n        var $tocElm = $('.' + tocClass, e.node);\n        if ($tocElm.length) {\n          $tocElm.removeAttr('contentEditable');\n          $tocElm.find('[contenteditable]').removeAttr('contentEditable');\n        }\n      });\n      editor.on('SetContent', function () {\n        var $tocElm = $('.' + tocClass);\n        if ($tocElm.length) {\n          $tocElm.attr('contentEditable', false);\n          $tocElm.children(':first-child').attr('contentEditable', true);\n        }\n      });\n    };\n    var FilterContent = { setup: setup };\n\n    var toggleState = function (editor) {\n      return function (api) {\n        var toggleDisabledState = function () {\n          return api.setDisabled(editor.readonly || !Toc.hasHeaders(editor));\n        };\n        toggleDisabledState();\n        editor.on('LoadContent SetContent change', toggleDisabledState);\n        return function () {\n          return editor.on('LoadContent SetContent change', toggleDisabledState);\n        };\n      };\n    };\n    var isToc = function (editor) {\n      return function (elm) {\n        return elm && editor.dom.is(elm, '.' + Settings.getTocClass(editor)) && editor.getBody().contains(elm);\n      };\n    };\n    var register$1 = function (editor) {\n      editor.ui.registry.addButton('toc', {\n        icon: 'toc',\n        tooltip: 'Table of contents',\n        onAction: function () {\n          return editor.execCommand('mceInsertToc');\n        },\n        onSetup: toggleState(editor)\n      });\n      editor.ui.registry.addButton('tocupdate', {\n        icon: 'reload',\n        tooltip: 'Update',\n        onAction: function () {\n          return editor.execCommand('mceUpdateToc');\n        }\n      });\n      editor.ui.registry.addMenuItem('toc', {\n        icon: 'toc',\n        text: 'Table of contents',\n        onAction: function () {\n          return editor.execCommand('mceInsertToc');\n        },\n        onSetup: toggleState(editor)\n      });\n      editor.ui.registry.addContextToolbar('toc', {\n        items: 'tocupdate',\n        predicate: isToc(editor),\n        scope: 'node',\n        position: 'node'\n      });\n    };\n    var Buttons = { register: register$1 };\n\n    function Plugin () {\n      global.add('toc', function (editor) {\n        Commands.register(editor);\n        Buttons.register(editor);\n        FilterContent.setup(editor);\n      });\n    }\n\n    Plugin();\n\n}());\n"]}